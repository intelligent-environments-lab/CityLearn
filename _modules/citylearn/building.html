

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>citylearn.building &mdash; CityLearn 2.4.3 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/sphinx-dropdown.css?v=995e94df" />
      <link rel="stylesheet" type="text/css" href="../../_static/panels-bootstrap.min.css?v=21c0b90a" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=7a6bd5fc"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../_static/copybutton.js?v=f281be69"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            CityLearn
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">QuickStart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview/index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage/index.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cli.html">Command Line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ui.html">CityLearn UI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/modules.html">citylearn</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../citylearn_challenge/index.html">The CityLearn Challenge</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../references.html">References</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">CityLearn</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">citylearn.building</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for citylearn.building</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">gymnasium</span><span class="w"> </span><span class="kn">import</span> <span class="n">spaces</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">citylearn.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">Environment</span><span class="p">,</span> <span class="n">EpisodeTracker</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">citylearn.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">CarbonIntensity</span><span class="p">,</span> <span class="n">EnergySimulation</span><span class="p">,</span> <span class="n">Pricing</span><span class="p">,</span> <span class="n">TOLERANCE</span><span class="p">,</span> <span class="n">Weather</span><span class="p">,</span> <span class="n">ZERO_DIVISION_PLACEHOLDER</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">citylearn.dynamics</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dynamics</span><span class="p">,</span> <span class="n">LSTMDynamics</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">citylearn.electric_vehicle_charger</span><span class="w"> </span><span class="kn">import</span> <span class="n">Charger</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">citylearn.energy_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">Battery</span><span class="p">,</span> <span class="n">ElectricDevice</span><span class="p">,</span> <span class="n">ElectricHeater</span><span class="p">,</span> <span class="n">HeatPump</span><span class="p">,</span> <span class="n">PV</span><span class="p">,</span> <span class="n">StorageDevice</span><span class="p">,</span> <span class="n">StorageTank</span><span class="p">,</span> <span class="n">WashingMachine</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">citylearn.occupant</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogisticRegressionOccupant</span><span class="p">,</span> <span class="n">Occupant</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">citylearn.power_outage</span><span class="w"> </span><span class="kn">import</span> <span class="n">PowerOutage</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">citylearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Normalize</span><span class="p">,</span> <span class="n">PeriodicNormalization</span>

<span class="n">LOGGER</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

<div class="viewcode-block" id="Building">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.Building">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Building</span><span class="p">(</span><span class="n">Environment</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Base class for building.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    energy_simulation : EnergySimulation</span>
<span class="sd">        Temporal features, cooling, heating, dhw and plug loads, solar generation and indoor environment time series.</span>
<span class="sd">    weather : Weather</span>
<span class="sd">        Outdoor weather conditions and forecasts time sereis.</span>
<span class="sd">    observation_metadata : dict</span>
<span class="sd">        Mapping of active and inactive observations.</span>
<span class="sd">    action_metadata : dict</span>
<span class="sd">        Mapping od active and inactive actions.</span>
<span class="sd">    episode_tracker: EpisodeTracker, optional</span>
<span class="sd">        :py:class:`citylearn.base.EpisodeTracker` object used to keep track of current episode time steps </span>
<span class="sd">        for reading observations from data files.</span>
<span class="sd">    carbon_intensity : CarbonIntensity, optional</span>
<span class="sd">        Carbon dioxide emission rate time series.</span>
<span class="sd">    pricing : Pricing, optional</span>
<span class="sd">        Energy pricing and forecasts time series.</span>
<span class="sd">    dhw_storage : StorageTank, optional</span>
<span class="sd">        Hot water storage object for domestic hot water.</span>
<span class="sd">    cooling_storage : StorageTank, optional</span>
<span class="sd">        Cold water storage object for space cooling.</span>
<span class="sd">    heating_storage : StorageTank, optional</span>
<span class="sd">        Hot water storage object for space heating.</span>
<span class="sd">    electrical_storage : Battery, optional</span>
<span class="sd">        Electric storage object for meeting electric loads.</span>
<span class="sd">    dhw_device : Union[HeatPump, ElectricHeater], optional</span>
<span class="sd">        Electric device for meeting hot domestic hot water demand and charging `dhw_storage`.</span>
<span class="sd">    cooling_device : HeatPump, optional</span>
<span class="sd">        Electric device for meeting space cooling demand and charging `cooling_storage`.</span>
<span class="sd">    heating_device : Union[HeatPump, ElectricHeater], optional</span>
<span class="sd">        Electric device for meeting space heating demand and charging `heating_storage`.</span>
<span class="sd">    pv : PV, optional</span>
<span class="sd">        PV object for offsetting electricity demand from grid.</span>
<span class="sd">    name : str, optional</span>
<span class="sd">        Unique building name.</span>
<span class="sd">    observation_space_limit_delta: float, default: 0.0</span>
<span class="sd">        +/- buffer for observation space limits after they have been dynamically calculated.</span>
<span class="sd">    maximum_temperature_delta: float, default: 20.0</span>
<span class="sd">        Expected maximum absolute temperature delta above and below indoor dry-bulb temperature in [C].</span>
<span class="sd">    demand_observation_limit_factor: float, default: 1.15</span>
<span class="sd">        Multiplier for maximum cooling/heating/dhw demand observations when setting observation limits.</span>
<span class="sd">    simulate_power_outage: bool, default: False</span>
<span class="sd">        Whether to allow time steps when the grid is unavailable and loads must be met using only the </span>
<span class="sd">        building&#39;s downward flexibility resources.</span>
<span class="sd">    stochastic_power_outage: bool, default: False</span>
<span class="sd">        Whether to use a stochastic function to determine outage time steps otherwise, </span>
<span class="sd">        :py:class:`citylearn.building.Building.energy_simulation.power_outage` time series is used.</span>
<span class="sd">    stochastic_power_outage_model: PowerOutage, optional</span>
<span class="sd">        Power outage model class used to generate stochastic power outage signals.</span>
<span class="sd">    carbon_intensity : CarbonIntensity, optional</span>
<span class="sd">        Carbon dioxide emission rate time series.</span>
<span class="sd">    electric_vehicle_chargers : Charger, optional</span>
<span class="sd">        Electric Vehicle Chargers associated with the building.</span>

<span class="sd">    Other Parameters</span>
<span class="sd">    ----------------</span>
<span class="sd">    **kwargs : Any</span>
<span class="sd">        Other keyword arguments used to initialize super class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">energy_simulation</span><span class="p">:</span> <span class="n">EnergySimulation</span><span class="p">,</span> <span class="n">weather</span><span class="p">:</span> <span class="n">Weather</span><span class="p">,</span> <span class="n">observation_metadata</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">],</span>
        <span class="n">action_metadata</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">],</span> <span class="n">episode_tracker</span><span class="p">:</span> <span class="n">EpisodeTracker</span><span class="p">,</span>
        <span class="n">carbon_intensity</span><span class="p">:</span> <span class="n">CarbonIntensity</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pricing</span><span class="p">:</span> <span class="n">Pricing</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dhw_storage</span><span class="p">:</span> <span class="n">StorageTank</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cooling_storage</span><span class="p">:</span> <span class="n">StorageTank</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">heating_storage</span><span class="p">:</span> <span class="n">StorageTank</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">electrical_storage</span><span class="p">:</span> <span class="n">Battery</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dhw_device</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">HeatPump</span><span class="p">,</span> <span class="n">ElectricHeater</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cooling_device</span><span class="p">:</span> <span class="n">HeatPump</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">heating_device</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">HeatPump</span><span class="p">,</span> <span class="n">ElectricHeater</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">pv</span><span class="p">:</span> <span class="n">PV</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">maximum_temperature_delta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">observation_space_limit_delta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">demand_observation_limit_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">simulate_power_outage</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">stochastic_power_outage</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">stochastic_power_outage_model</span><span class="p">:</span> <span class="n">PowerOutage</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">electric_vehicle_chargers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Charger</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">time_step_ratio</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">washing_machines</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">WashingMachine</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">):</span>
        <span class="n">charging_constraints</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;charging_constraints&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dhw_storage</span> <span class="o">=</span> <span class="n">dhw_storage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cooling_storage</span> <span class="o">=</span> <span class="n">cooling_storage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heating_storage</span> <span class="o">=</span> <span class="n">heating_storage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">electrical_storage</span> <span class="o">=</span> <span class="n">electrical_storage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span> <span class="o">=</span> <span class="n">dhw_device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cooling_device</span> <span class="o">=</span> <span class="n">cooling_device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span> <span class="o">=</span> <span class="n">heating_device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__non_shiftable_load_device</span> <span class="o">=</span> <span class="n">ElectricDevice</span><span class="p">(</span><span class="n">nominal_power</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pv</span> <span class="o">=</span> <span class="n">pv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_step_ratio</span><span class="o">=</span><span class="n">time_step_ratio</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">seconds_per_time_step</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;seconds_per_time_step&#39;</span><span class="p">),</span>
            <span class="n">random_seed</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;random_seed&#39;</span><span class="p">),</span>
            <span class="n">episode_tracker</span><span class="o">=</span><span class="n">episode_tracker</span><span class="p">,</span>
            <span class="n">time_step_ratio</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step_ratio</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">algorithm_action_based_time_step_hours_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seconds_per_time_step</span> <span class="o">/</span> <span class="mi">3600</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stochastic_power_outage_model</span> <span class="o">=</span> <span class="n">stochastic_power_outage_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">washing_machines</span> <span class="o">=</span> <span class="n">washing_machines</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">electric_vehicle_chargers</span> <span class="o">=</span> <span class="n">electric_vehicle_chargers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span> <span class="o">=</span> <span class="n">energy_simulation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weather</span> <span class="o">=</span> <span class="n">weather</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">carbon_intensity</span> <span class="o">=</span> <span class="n">carbon_intensity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pricing</span> <span class="o">=</span> <span class="n">pricing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observation_metadata</span> <span class="o">=</span> <span class="n">observation_metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action_metadata</span> <span class="o">=</span> <span class="n">action_metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observation_space_limit_delta</span> <span class="o">=</span> <span class="n">observation_space_limit_delta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maximum_temperature_delta</span> <span class="o">=</span> <span class="n">maximum_temperature_delta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">demand_observation_limit_factor</span> <span class="o">=</span> <span class="n">demand_observation_limit_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simulate_power_outage</span> <span class="o">=</span> <span class="n">simulate_power_outage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stochastic_power_outage</span> <span class="o">=</span> <span class="n">stochastic_power_outage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">non_periodic_normalized_observation_space_limits</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">periodic_normalized_observation_space_limits</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observation_space</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_observation_space</span><span class="p">(</span><span class="n">include_all</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action_space</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_action_space</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_charging_constraints</span><span class="p">(</span><span class="n">charging_constraints</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">energy_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EnergySimulation</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Temporal features, cooling, heating, dhw and plug loads, solar generation and indoor environment time series.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__energy_simulation</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">weather</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Weather</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Outdoor weather conditions and forecasts time series.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__weather</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">observation_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Mapping of active and inactive observations.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__observation_metadata</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">action_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Mapping od active and inactive actions.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__action_metadata</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">carbon_intensity</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CarbonIntensity</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Carbon dioxide emission rate time series.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__carbon_intensity</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">pricing</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Pricing</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Energy pricing and forecasts time series.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pricing</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">dhw_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StorageTank</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Hot water storage object for domestic hot water.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dhw_storage</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cooling_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StorageTank</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Cold water storage object for space cooling.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cooling_storage</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">heating_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StorageTank</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Hot water storage object for space heating.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__heating_storage</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">electrical_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Battery</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Electric storage object for meeting electric loads.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__electrical_storage</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">dhw_device</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">HeatPump</span><span class="p">,</span> <span class="n">ElectricHeater</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Electric device for meeting hot domestic hot water demand and charging `dhw_storage`.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dhw_device</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cooling_device</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HeatPump</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Electric device for meeting space cooling demand and charging `cooling_storage`.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cooling_device</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">heating_device</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">HeatPump</span><span class="p">,</span> <span class="n">ElectricHeater</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Electric device for meeting space heating demand and charging `heating_storage`.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__heating_device</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">non_shiftable_load_device</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ElectricDevice</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generic electric device for meeting non_shiftable_load.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__non_shiftable_load_device</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">pv</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PV</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;PV object for offsetting electricity demand from grid.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pv</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">electric_vehicle_chargers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Charger</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Electric Vehicle Chargers associated with the building for charging connected eletric vehicles.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__electric_vehicle_chargers</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">charger_phase_map</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_charger_phase_map&#39;</span><span class="p">,</span> <span class="p">{})</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">charging_building_limit_kw</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_building_charger_limit_kw&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">washing_machines</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">WashingMachine</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Electric Vehicle Chargers associated with the building for charging connected eletric vehicles.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__washing_machines</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Unique building name.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__name</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">observation_space_limit_delta</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;+/- buffer for observation space limits after they have been dynamically calculated.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__observation_space_limit_delta</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">maximum_temperature_delta</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Expected maximum absolute temperature delta above and below indoor dry-bulb temperature in [C].&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__maximum_temperature_delta</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">demand_observation_limit_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Multiplier for maximum cooling/heating/dhw demand observations when setting observation limits.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__demand_observation_limit_factor</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">simulate_power_outage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Whether to allow time steps when the grid is unavailable and loads must be met using only the </span>
<span class="sd">        building&#39;s downward flexibility resources.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__simulate_power_outage</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">stochastic_power_outage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Whether to use a stochastic function to determine outage time steps otherwise, </span>
<span class="sd">        :py:class:`citylearn.building.Building.energy_simulation.power_outage` time series is used.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__stochastic_power_outage</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">observation_space</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">spaces</span><span class="o">.</span><span class="n">Box</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Agent observation space.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__observation_space</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">action_space</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">spaces</span><span class="o">.</span><span class="n">Box</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Agent action spaces.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__action_space</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">active_observations</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Observations in `observation_metadata` with True value i.e. obeservable.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation_metadata</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">active_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Actions in `action_metadata` with True value i.e. </span>
<span class="sd">        indicates which storage systems are to be controlled during simulation.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_metadata</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">net_electricity_consumption_emission_without_storage_and_pv</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Carbon dioxide emmission from `net_electricity_consumption_without_storage_pv` time series, in [kg_co2].&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">carbon_intensity</span><span class="o">.</span><span class="n">carbon_intensity</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">net_electricity_consumption_without_storage_and_pv</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">net_electricity_consumption_cost_without_storage_and_pv</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;net_electricity_consumption_without_storage_and_pv` cost time series, in [$].&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pricing</span><span class="o">.</span><span class="n">electricity_pricing</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">net_electricity_consumption_without_storage_and_pv</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">net_electricity_consumption_without_storage_and_pv</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Net electricity consumption in the absence of flexibility provided by storage devices, </span>
<span class="sd">        and self generation time series, in [kWh]. </span>
<span class="sd">        </span>
<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        net_electricity_consumption_without_storage_and_pv = </span>
<span class="sd">        `net_electricity_consumption_without_storage` - `solar_generation`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">net_electricity_consumption_without_storage</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">solar_generation</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">net_electricity_consumption_emission_without_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Carbon dioxide emmission from `net_electricity_consumption_without_storage` time series, in [kg_co2].&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">carbon_intensity</span><span class="o">.</span><span class="n">carbon_intensity</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">net_electricity_consumption_without_storage</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">net_electricity_consumption_cost_without_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;`net_electricity_consumption_without_storage` cost time series, in [$].&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pricing</span><span class="o">.</span><span class="n">electricity_pricing</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">net_electricity_consumption_without_storage</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">net_electricity_consumption_without_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;net electricity consumption in the absence of flexibility provided by storage devices time series, in [kWh]. </span>
<span class="sd">        </span>
<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        net_electricity_consumption_without_storage = `net_electricity_consumption` - (`cooling_storage_electricity_consumption`</span>
<span class="sd">        + `heating_storage_electricity_consumption` + `dhw_storage_electricity_consumption` + `electrical_storage_electricity_consumption` + `charger_electricity_consumption`)</span>

<span class="sd">        Regarding electric vehicles there is:</span>
<span class="sd">        chargers_electricity_consumption -&gt; Sum of the electricity consumption of all electric_vehicle_chargers in the building</span>

<span class="sd">        So, the first one is subtracted from the net_electricity_consumption, obtaining the energy consumption as if the cars were not used at all.</span>
<span class="sd">        However, if there are chargers and EVs, they need to charge per usual, so that consumption is added</span>
<span class="sd">        This is what allows to check if the control mechanism affects the grid balancing scheme for EVs for example.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">net_electricity_consumption</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cooling_storage_electricity_consumption</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">heating_storage_electricity_consumption</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dhw_storage_electricity_consumption</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">electrical_storage_electricity_consumption</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chargers_electricity_consumption</span><span class="p">,</span>
        <span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">net_electricity_consumption_emission</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Carbon dioxide emmission from `net_electricity_consumption` time series, in [kg_co2].&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__net_electricity_consumption_emission</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">net_electricity_consumption_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;`net_electricity_consumption` cost time series, in [$].&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__net_electricity_consumption_cost</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">net_electricity_consumption</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Net electricity consumption time series, in [kWh].&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__net_electricity_consumption</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cooling_electricity_consumption</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;`cooling_device` net electricity consumption in meeting cooling demand and `cooling_storage` energy demand time series, in [kWh]. </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooling_device</span><span class="o">.</span><span class="n">electricity_consumption</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">heating_electricity_consumption</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;`heating_device` net electricity consumption in meeting heating demand and `heating_storage` energy demand time series, in [kWh]. </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">electricity_consumption</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">dhw_electricity_consumption</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;`dhw_device` net electricity consumption in meeting domestic hot water and `dhw_storage` energy demand time series, in [kWh]. </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="o">.</span><span class="n">electricity_consumption</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">non_shiftable_load_electricity_consumption</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;`non_shiftable_load_device` net electricity consumption in meeting `non_shiftable_load` energy demand time series, in [kWh]. </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_shiftable_load_device</span><span class="o">.</span><span class="n">electricity_consumption</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cooling_storage_electricity_consumption</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;`cooling_storage` net electricity consumption time series, in [kWh]. </span>
<span class="sd">        </span>
<span class="sd">        Positive values indicate `cooling_device` electricity consumption to charge `cooling_storage` while negative values indicate avoided `cooling_device` </span>
<span class="sd">        electricity consumption by discharging `cooling_storage` to meet `cooling_demand`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooling_device</span><span class="o">.</span><span class="n">get_input_power</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cooling_storage</span><span class="o">.</span><span class="n">energy_balance</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weather</span><span class="o">.</span><span class="n">outdoor_dry_bulb_temperature</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="kc">False</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">heating_storage_electricity_consumption</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;`heating_storage` net electricity consumption time series, in [kWh]. </span>
<span class="sd">        </span>
<span class="sd">        Positive values indicate `heating_device` electricity consumption to charge `heating_storage` while negative values indicate avoided `heating_device` </span>
<span class="sd">        electricity consumption by discharging `heating_storage` to meet `heating_demand`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="p">,</span> <span class="n">HeatPump</span><span class="p">):</span>
            <span class="n">consumption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">get_input_power</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">heating_storage</span><span class="o">.</span><span class="n">energy_balance</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">weather</span><span class="o">.</span><span class="n">outdoor_dry_bulb_temperature</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">consumption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">get_input_power</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heating_storage</span><span class="o">.</span><span class="n">energy_balance</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">consumption</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">dhw_storage_electricity_consumption</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;`dhw_storage` net electricity consumption time series, in [kWh]. </span>
<span class="sd">        </span>
<span class="sd">        Positive values indicate `dhw_device` electricity consumption to charge `dhw_storage` while negative values indicate avoided `dhw_device` </span>
<span class="sd">        electricity consumption by discharging `dhw_storage` to meet `dhw_demand`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="p">,</span> <span class="n">HeatPump</span><span class="p">):</span>
            <span class="n">consumption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="o">.</span><span class="n">get_input_power</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dhw_storage</span><span class="o">.</span><span class="n">energy_balance</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">weather</span><span class="o">.</span><span class="n">outdoor_dry_bulb_temperature</span><span class="p">[</span>
                <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">consumption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="o">.</span><span class="n">get_input_power</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dhw_storage</span><span class="o">.</span><span class="n">energy_balance</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">consumption</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">electrical_storage_electricity_consumption</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Energy supply from grid and/or `PV` to `electrical_storage` time series, in [kWh].&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">electrical_storage</span><span class="o">.</span><span class="n">electricity_consumption</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">chargers_electricity_consumption</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Electricity consumption of chargers time series, in [kWh].&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__chargers_electricity_consumption</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">washing_machines_electricity_consumption</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Electricity consumption of chargers time series, in [kWh].&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__washing_machines_electricity_consumption</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">energy_from_cooling_device_to_cooling_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Energy supply from `cooling_device` to `cooling_storage` time series, in [kWh].&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooling_storage</span><span class="o">.</span><span class="n">energy_balance</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)[:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">energy_from_heating_device_to_heating_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Energy supply from `heating_device` to `heating_storage` time series, in [kWh].&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_storage</span><span class="o">.</span><span class="n">energy_balance</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)[:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">energy_from_dhw_device_to_dhw_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Energy supply from `dhw_device` to `dhw_storage` time series, in [kWh].&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_storage</span><span class="o">.</span><span class="n">energy_balance</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)[:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">energy_to_electrical_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Energy supply from `electrical_device` to building time series, in [kWh].&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">electrical_storage</span><span class="o">.</span><span class="n">energy_balance</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)[:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">energy_from_cooling_device</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Energy supply from `cooling_device` to building time series, in [kWh].&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__energy_from_cooling_device</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">energy_from_heating_device</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Energy supply from `heating_device` to building time series, in [kWh].&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__energy_from_heating_device</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">energy_from_dhw_device</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Energy supply from `dhw_device` to building time series, in [kWh].&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__energy_from_dhw_device</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">energy_to_non_shiftable_load</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Energy supply from grid, PV and battery to non shiftable loads, in [kWh].&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__energy_to_non_shiftable_load</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">energy_from_cooling_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Energy supply from `cooling_storage` to building time series, in [kWh].&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooling_storage</span><span class="o">.</span><span class="n">energy_balance</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="nb">max</span><span class="o">=</span><span class="mi">0</span><span class="p">)[:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">energy_from_heating_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Energy supply from `heating_storage` to building time series, in [kWh].&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_storage</span><span class="o">.</span><span class="n">energy_balance</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="nb">max</span><span class="o">=</span><span class="mi">0</span><span class="p">)[:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">energy_from_dhw_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Energy supply from `dhw_storage` to building time series, in [kWh].&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_storage</span><span class="o">.</span><span class="n">energy_balance</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="nb">max</span><span class="o">=</span><span class="mi">0</span><span class="p">)[:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">energy_from_electrical_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Energy supply from `electrical_storage` to building time series, in [kWh].&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">electrical_storage</span><span class="o">.</span><span class="n">energy_balance</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="nb">max</span><span class="o">=</span><span class="mi">0</span><span class="p">)[:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">indoor_dry_bulb_temperature</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;dry bulb temperature time series, in [C].</span>
<span class="sd">        </span>
<span class="sd">        This is the temperature when cooling_device and heating_device are controlled.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">indoor_dry_bulb_temperature</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">indoor_dry_bulb_temperature_cooling_set_point</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dry bulb temperature cooling set point time series, in [C].&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">indoor_dry_bulb_temperature_cooling_set_point</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">indoor_dry_bulb_temperature_heating_set_point</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dry bulb temperature heating set point time series, in [C].&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">indoor_dry_bulb_temperature_heating_set_point</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">comfort_band</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Occupant comfort band above the `indoor_dry_bulb_temperature_cooling_set_point` and below the `indoor_dry_bulb_temperature_heating_set_point`, in [C].&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">comfort_band</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">occupant_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Building occupant count time series, in [people].&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">occupant_count</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cooling_demand</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Space cooling demand to be met by `cooling_device` and/or `cooling_storage` time series, in [kWh].&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">cooling_demand</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">heating_demand</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Space heating demand to be met by `heating_device` and/or `heating_storage` time series, in [kWh].&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">heating_demand</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">dhw_demand</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Domestic hot water demand to be met by `dhw_device` and/or `dhw_storage` time series, in [kWh].&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">dhw_demand</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">non_shiftable_load</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Electricity load that must be met by the grid, or `PV` and/or `electrical_storage` if available time series, in [kWh].&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">non_shiftable_load</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cooling_device_cop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Heat pump `cooling_device` coefficient of performance time series.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooling_device</span><span class="o">.</span><span class="n">get_cop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weather</span><span class="o">.</span><span class="n">outdoor_dry_bulb_temperature</span><span class="p">,</span> <span class="n">heating</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">heating_device_cop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Heat pump `heating_device` coefficient of performance or electric heater `heating_device` static technical efficiency time series.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">get_cop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weather</span><span class="o">.</span><span class="n">outdoor_dry_bulb_temperature</span><span class="p">,</span> <span class="n">heating</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> \
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="p">,</span> <span class="n">HeatPump</span><span class="p">)</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">dhw_device_cop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Heat pump `dhw_device` coefficient of performance or electric heater `dhw_device` static technical efficiency time series.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="o">.</span><span class="n">get_cop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weather</span><span class="o">.</span><span class="n">outdoor_dry_bulb_temperature</span><span class="p">,</span> <span class="n">heating</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> \
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="p">,</span> <span class="n">HeatPump</span><span class="p">)</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">solar_generation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;`PV` solar generation (negative value) time series, in [kWh].&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__solar_generation</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">power_outage_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Power outage signal time series, in [Yes/No].&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__power_outage_signal</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">downward_electrical_flexibility</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Available distributed energy resource capacity to satisfy electric loads while considering power outage at current time step.</span>
<span class="sd">        </span>
<span class="sd">        It is the sum of solar generation and any discharge from electrical storage, less electricity consumption by cooling, heating, </span>
<span class="sd">        dhw and non-shfitable load devices as well as charging electrical storage. When there is no power outage, the returned value </span>
<span class="sd">        is `np.inf`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">capacity</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solar_generation</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cooling_device</span><span class="o">.</span><span class="n">electricity_consumption</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">electricity_consumption</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="o">.</span><span class="n">electricity_consumption</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_shiftable_load_device</span><span class="o">.</span><span class="n">electricity_consumption</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">electrical_storage</span><span class="o">.</span><span class="n">electricity_consumption</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">capacity</span> <span class="o">=</span> <span class="n">capacity</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_outage</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>

        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;downward_electrical_flexibility must be &gt;= 0.0!&#39;</span> \
            <span class="sa">f</span><span class="s1">&#39;time step:, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="si">}</span><span class="s1">, outage:, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">power_outage</span><span class="si">}</span><span class="s1">, capacity:, </span><span class="si">{</span><span class="n">capacity</span><span class="si">}</span><span class="s1">,&#39;</span> \
                <span class="sa">f</span><span class="s1">&#39; solar:, </span><span class="si">{</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solar_generation</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">])</span><span class="si">}</span><span class="s1">,&#39;</span> \
                    <span class="sa">f</span><span class="s1">&#39; cooling:, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cooling_device</span><span class="o">.</span><span class="n">electricity_consumption</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span><span class="si">}</span><span class="s1">,&#39;</span> \
                        <span class="sa">f</span><span class="s1">&#39; heating:, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">electricity_consumption</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span><span class="si">}</span><span class="s1">,&#39;</span> \
                            <span class="sa">f</span><span class="s1">&#39;dhw:, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="o">.</span><span class="n">electricity_consumption</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span><span class="si">}</span><span class="s1">,&#39;</span> \
                                <span class="sa">f</span><span class="s1">&#39;non-shiftable:, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">non_shiftable_load_device</span><span class="o">.</span><span class="n">electricity_consumption</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span><span class="si">}</span><span class="s1">,&#39;</span> \
                                    <span class="sa">f</span><span class="s1">&#39; battery:, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">electrical_storage</span><span class="o">.</span><span class="n">electricity_consumption</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">assert</span> <span class="n">capacity</span> <span class="o">&gt;=</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">capacity</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">TOLERANCE</span><span class="p">,</span> <span class="n">message</span>
        <span class="n">capacity</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">capacity</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">capacity</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">power_outage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Whether there is power outage at current time step.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_power_outage</span> <span class="ow">and</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__power_outage_signal</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">stochastic_power_outage_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PowerOutage</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Power outage model class used to generate stochastic power outage signals.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__stochastic_power_outage_model</span>

    <span class="nd">@energy_simulation</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">energy_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">energy_simulation</span><span class="p">:</span> <span class="n">EnergySimulation</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__energy_simulation</span> <span class="o">=</span> <span class="n">energy_simulation</span>

    <span class="nd">@weather</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">weather</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weather</span><span class="p">:</span> <span class="n">Weather</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__weather</span> <span class="o">=</span> <span class="n">weather</span>

    <span class="nd">@observation_metadata</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">observation_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observation_metadata</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__observation_metadata</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">observation_metadata</span><span class="p">)</span>

    <span class="nd">@action_metadata</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">action_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action_metadata</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__action_metadata</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">action_metadata</span><span class="p">)</span>

    <span class="nd">@carbon_intensity</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">carbon_intensity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">carbon_intensity</span><span class="p">:</span> <span class="n">CarbonIntensity</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">carbon_intensity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__carbon_intensity</span> <span class="o">=</span> <span class="n">CarbonIntensity</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_time_steps</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__carbon_intensity</span> <span class="o">=</span> <span class="n">carbon_intensity</span>

    <span class="nd">@pricing</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">pricing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pricing</span><span class="p">:</span> <span class="n">Pricing</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pricing</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__pricing</span> <span class="o">=</span> <span class="n">Pricing</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_time_steps</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_time_steps</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_time_steps</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_time_steps</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__pricing</span> <span class="o">=</span> <span class="n">pricing</span>

    <span class="nd">@dhw_storage</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">dhw_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dhw_storage</span><span class="p">:</span> <span class="n">StorageTank</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__dhw_storage</span> <span class="o">=</span> <span class="n">StorageTank</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span> <span class="k">if</span> <span class="n">dhw_storage</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">dhw_storage</span>

    <span class="nd">@cooling_storage</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cooling_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cooling_storage</span><span class="p">:</span> <span class="n">StorageTank</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__cooling_storage</span> <span class="o">=</span> <span class="n">StorageTank</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span> <span class="k">if</span> <span class="n">cooling_storage</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">cooling_storage</span>

    <span class="nd">@heating_storage</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">heating_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">heating_storage</span><span class="p">:</span> <span class="n">StorageTank</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__heating_storage</span> <span class="o">=</span> <span class="n">StorageTank</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span> <span class="k">if</span> <span class="n">heating_storage</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">heating_storage</span>

    <span class="nd">@electrical_storage</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">electrical_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">electrical_storage</span><span class="p">:</span> <span class="n">Battery</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__electrical_storage</span> <span class="o">=</span> <span class="n">Battery</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="k">if</span> <span class="n">electrical_storage</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">electrical_storage</span>

    <span class="nd">@dhw_device</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">dhw_device</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dhw_device</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">HeatPump</span><span class="p">,</span> <span class="n">ElectricHeater</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__dhw_device</span> <span class="o">=</span> <span class="n">ElectricHeater</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span> <span class="k">if</span> <span class="n">dhw_device</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">dhw_device</span>

    <span class="nd">@cooling_device</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cooling_device</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cooling_device</span><span class="p">:</span> <span class="n">HeatPump</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__cooling_device</span> <span class="o">=</span> <span class="n">HeatPump</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span> <span class="k">if</span> <span class="n">cooling_device</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">cooling_device</span>

    <span class="nd">@heating_device</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">heating_device</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">heating_device</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">HeatPump</span><span class="p">,</span> <span class="n">ElectricHeater</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__heating_device</span> <span class="o">=</span> <span class="n">HeatPump</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span> <span class="k">if</span> <span class="n">heating_device</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">heating_device</span>

    <span class="nd">@pv</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">pv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pv</span><span class="p">:</span> <span class="n">PV</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__pv</span> <span class="o">=</span> <span class="n">PV</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span> <span class="k">if</span> <span class="n">pv</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">pv</span>

    <span class="nd">@electric_vehicle_chargers</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">electric_vehicle_chargers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">electric_vehicle_chargers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Charger</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__electric_vehicle_chargers</span> <span class="o">=</span> <span class="n">electric_vehicle_chargers</span> <span class="k">if</span> <span class="n">electric_vehicle_chargers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_charger_lookup</span><span class="p">()</span>

    <span class="nd">@washing_machines</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">washing_machines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">washing_machines</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">WashingMachine</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__washing_machines</span> <span class="o">=</span> <span class="n">washing_machines</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_update_charger_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">chargers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__electric_vehicle_chargers</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_Building__electric_vehicle_chargers&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_charger_lookup</span> <span class="o">=</span> <span class="p">{</span><span class="n">charger</span><span class="o">.</span><span class="n">charger_id</span><span class="p">:</span> <span class="n">charger</span> <span class="k">for</span> <span class="n">charger</span> <span class="ow">in</span> <span class="n">chargers</span><span class="p">}</span> <span class="k">if</span> <span class="n">chargers</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_include_phase_encoding&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_phase_encoding_observations</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_charging_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_charging_constraints_config</span> <span class="o">=</span> <span class="n">config</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_charging_constraints_enabled</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_charging_constraints_config</span><span class="p">)</span>
        <span class="n">observations_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_charging_constraints_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;observations&#39;</span><span class="p">,</span> <span class="p">{})</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="n">expose_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_charging_constraints_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;expose_observations&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;headroom&#39;</span> <span class="ow">in</span> <span class="n">observations_config</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_expose_charging_constraints</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">observations_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;headroom&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">expose_flag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_expose_charging_constraints</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">expose_flag</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_expose_charging_constraints</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_expose_charging_violation</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">observations_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;violation&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_include_phase_encoding</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">observations_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;phase_encoding&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_building_charger_limit_kw</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_phase_limits</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_charger_phase_map</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_charging_constraints_state</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_charging_constraint_penalty_kwh</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_charging_constraint_last_penalty_kwh</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_phase_encoding_observations</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_phase_encoding_phase_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_charging_constraints_enabled</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_charging_constraints_state</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_building_charger_limit_kw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_charging_constraints_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;building_limit_kw&#39;</span><span class="p">)</span>
        <span class="n">phases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_charging_constraints_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;phases&#39;</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="n">phases</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;phase_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_limits</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;limit_kw&#39;</span><span class="p">)</span>
            <span class="n">chargers</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;chargers&#39;</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_phase_limits</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;limit_kw&#39;</span><span class="p">:</span> <span class="n">limit</span><span class="p">,</span> <span class="s1">&#39;chargers&#39;</span><span class="p">:</span> <span class="n">chargers</span><span class="p">})</span>
            <span class="k">for</span> <span class="n">charger_id</span> <span class="ow">in</span> <span class="n">chargers</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_charger_phase_map</span><span class="p">[</span><span class="n">charger_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_include_phase_encoding</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase_limits</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_include_phase_encoding</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_update_phase_encoding_observations</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expose_charging_constraints</span><span class="p">:</span>
            <span class="n">observation_keys</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_building_charger_limit_kw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">observation_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;charging_building_headroom_kw&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase_limits</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">phase</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;limit_kw&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">observation_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;charging_phase_</span><span class="si">{</span><span class="n">phase</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_headroom_kw&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">observation_keys</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation_metadata</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">observation_metadata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># Recompute observation space to include new limits</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">observation_space</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_observation_space</span><span class="p">(</span><span class="n">include_all</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">violation_key</span> <span class="o">=</span> <span class="s1">&#39;charging_constraint_violation_kwh&#39;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;observation_metadata&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">observation_metadata</span><span class="p">[</span><span class="n">violation_key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expose_charging_violation</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_include_phase_encoding</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase_encoding_observations</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation_metadata</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">observation_metadata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_default_charging_headroom</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;observation_metadata&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">observation_space</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_observation_space</span><span class="p">(</span><span class="n">include_all</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_update_phase_encoding_observations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">previous_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_phase_encoding_observation_keys&#39;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_phase_encoding_observation_keys</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_include_phase_encoding&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_phase_encoding_observations</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_phase_encoding_phase_names</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_phase_encoding_observation_keys</span> <span class="o">=</span> <span class="n">previous_keys</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;observation_metadata&#39;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">previous_keys</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation_metadata</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">observation_metadata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;observation_metadata&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">observation_space</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_observation_space</span><span class="p">(</span><span class="n">include_all</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_charger_lookup&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_phase_encoding_observations</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">return</span>

        <span class="n">chargers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_charger_lookup</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">chargers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_phase_encoding_observations</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">return</span>

        <span class="n">phase_names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">({</span><span class="n">phase</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase_limits</span> <span class="k">if</span> <span class="n">phase</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)})</span>
        <span class="n">has_unassigned</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">charger_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_charger_phase_map</span> <span class="k">for</span> <span class="n">charger_id</span> <span class="ow">in</span> <span class="n">chargers</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">has_unassigned</span><span class="p">:</span>
            <span class="n">phase_names</span> <span class="o">=</span> <span class="n">phase_names</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;unassigned&#39;</span><span class="p">]</span>

        <span class="n">observations</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">charger_id</span> <span class="ow">in</span> <span class="n">chargers</span><span class="p">:</span>
            <span class="n">assigned_phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_charger_phase_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">charger_id</span><span class="p">,</span> <span class="s1">&#39;unassigned&#39;</span> <span class="k">if</span> <span class="n">has_unassigned</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">phase_name</span> <span class="ow">in</span> <span class="n">phase_names</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;charging_phase_one_hot_</span><span class="si">{</span><span class="n">charger_id</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="n">observations</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="n">assigned_phase</span> <span class="o">==</span> <span class="n">phase_name</span> <span class="k">else</span> <span class="mf">0.0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_phase_encoding_observations</span> <span class="o">=</span> <span class="n">observations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_phase_encoding_phase_names</span> <span class="o">=</span> <span class="n">phase_names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_phase_encoding_observation_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">observations</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;observation_metadata&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">observations</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">observation_metadata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;observation_metadata&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">observation_space</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_observation_space</span><span class="p">(</span><span class="n">include_all</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_set_default_charging_headroom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_charging_constraints_enabled</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_expose_charging_constraints&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_charging_constraints_state</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span>

        <span class="n">building_headroom</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_building_charger_limit_kw</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_building_charger_limit_kw</span><span class="p">)</span>
        <span class="n">phase_headroom</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">phase</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]:</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">phase</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;limit_kw&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="n">phase</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;limit_kw&#39;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase_limits</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_charging_constraints_state</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;building_headroom_kw&#39;</span><span class="p">:</span> <span class="n">building_headroom</span><span class="p">,</span>
            <span class="s1">&#39;phase_headroom_kw&#39;</span><span class="p">:</span> <span class="n">phase_headroom</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_charging_constraints_to_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">actions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_charging_constraint_penalty_kwh</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_charging_constraint_last_penalty_kwh</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_charging_constraints_enabled</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">actions</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">actions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_default_charging_headroom</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">actions</span>

        <span class="n">positive_requests</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">scales</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">charger_id</span><span class="p">,</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">actions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">action</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">action</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">charger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_charger_lookup</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">charger_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">charger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">max_power</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">charger</span><span class="p">,</span> <span class="s1">&#39;max_charging_power&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="ow">or</span> <span class="mf">0.0</span>
            <span class="k">if</span> <span class="n">max_power</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">positive_requests</span><span class="p">[</span><span class="n">charger_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">action</span> <span class="o">*</span> <span class="n">max_power</span>
            <span class="n">scales</span><span class="p">[</span><span class="n">charger_id</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="n">violation_kw</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">if</span> <span class="n">positive_requests</span><span class="p">:</span>
            <span class="n">total_kw</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">positive_requests</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">building_limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_building_charger_limit_kw</span>
            <span class="k">if</span> <span class="n">building_limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">building_limit</span> <span class="o">&gt;=</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="n">total_kw</span> <span class="o">&gt;</span> <span class="n">building_limit</span><span class="p">:</span>
                <span class="n">scale</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="k">if</span> <span class="n">building_limit</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">building_limit</span> <span class="o">/</span> <span class="n">total_kw</span>
                <span class="k">for</span> <span class="n">cid</span> <span class="ow">in</span> <span class="n">scales</span><span class="p">:</span>
                    <span class="n">scales</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*=</span> <span class="n">scale</span>
                <span class="n">violation_kw</span> <span class="o">+=</span> <span class="n">total_kw</span> <span class="o">-</span> <span class="n">building_limit</span>

            <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase_limits</span><span class="p">:</span>
                <span class="n">limit</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;limit_kw&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">limit</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">chargers</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;chargers&#39;</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
                <span class="n">phase_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">positive_requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">scales</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="k">for</span> <span class="n">cid</span> <span class="ow">in</span> <span class="n">chargers</span> <span class="k">if</span> <span class="n">cid</span> <span class="ow">in</span> <span class="n">positive_requests</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">phase_sum</span> <span class="o">&gt;</span> <span class="n">limit</span><span class="p">:</span>
                    <span class="n">phase_scale</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="k">if</span> <span class="n">limit</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">limit</span> <span class="o">/</span> <span class="n">phase_sum</span>
                    <span class="k">for</span> <span class="n">cid</span> <span class="ow">in</span> <span class="n">chargers</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">cid</span> <span class="ow">in</span> <span class="n">scales</span><span class="p">:</span>
                            <span class="n">scales</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*=</span> <span class="n">phase_scale</span>
                    <span class="n">violation_kw</span> <span class="o">+=</span> <span class="n">phase_sum</span> <span class="o">-</span> <span class="n">limit</span>

            <span class="n">scaled_positive_kw</span> <span class="o">=</span> <span class="p">{</span><span class="n">cid</span><span class="p">:</span> <span class="n">positive_requests</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="n">scales</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="k">for</span> <span class="n">cid</span> <span class="ow">in</span> <span class="n">positive_requests</span><span class="p">}</span>

            <span class="k">for</span> <span class="n">charger_id</span><span class="p">,</span> <span class="n">action</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">actions</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">action</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">action</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">charger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_charger_lookup</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">charger_id</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">charger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">max_power</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">charger</span><span class="p">,</span> <span class="s1">&#39;max_charging_power&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="ow">or</span> <span class="mf">0.0</span>
                <span class="k">if</span> <span class="n">max_power</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">actions</span><span class="p">[</span><span class="n">charger_id</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="k">continue</span>
                <span class="n">target_kw</span> <span class="o">=</span> <span class="n">scaled_positive_kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">charger_id</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
                <span class="n">actions</span><span class="p">[</span><span class="n">charger_id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">target_kw</span> <span class="o">/</span> <span class="n">max_power</span><span class="p">))</span>

            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_expose_charging_constraints&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">used_kw</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">scaled_positive_kw</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                <span class="n">building_headroom</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_building_charger_limit_kw</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_building_charger_limit_kw</span> <span class="o">-</span> <span class="n">used_kw</span>
                <span class="n">phase_headroom</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase_limits</span><span class="p">:</span>
                    <span class="n">limit</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;limit_kw&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">phase_headroom</span><span class="p">[</span><span class="n">phase</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">used</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">scaled_positive_kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="k">for</span> <span class="n">cid</span> <span class="ow">in</span> <span class="n">phase</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;chargers&#39;</span><span class="p">,</span> <span class="p">[]))</span>
                        <span class="n">phase_headroom</span><span class="p">[</span><span class="n">phase</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">limit</span> <span class="o">-</span> <span class="n">used</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_charging_constraints_state</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;building_headroom_kw&#39;</span><span class="p">:</span> <span class="n">building_headroom</span><span class="p">,</span>
                    <span class="s1">&#39;phase_headroom_kw&#39;</span><span class="p">:</span> <span class="n">phase_headroom</span><span class="p">,</span>
                <span class="p">}</span>

            <span class="n">penalty_kwh</span> <span class="o">=</span> <span class="n">violation_kw</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seconds_per_time_step</span> <span class="o">/</span> <span class="mi">3600</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_charging_constraint_penalty_kwh</span> <span class="o">=</span> <span class="n">penalty_kwh</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_charging_constraint_last_penalty_kwh</span> <span class="o">=</span> <span class="n">penalty_kwh</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_default_charging_headroom</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">actions</span>

<div class="viewcode-block" id="Building.consume_charging_constraint_penalty">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.Building.consume_charging_constraint_penalty">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">consume_charging_constraint_penalty</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">penalty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_charging_constraint_penalty_kwh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_charging_constraint_penalty_kwh</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">return</span> <span class="n">penalty</span></div>


    <span class="nd">@observation_space</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">observation_space</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observation_space</span><span class="p">:</span> <span class="n">spaces</span><span class="o">.</span><span class="n">Box</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__observation_space</span> <span class="o">=</span> <span class="n">observation_space</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">non_periodic_normalized_observation_space_limits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_observation_space_limits</span><span class="p">(</span><span class="n">include_all</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">periodic_normalization</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">periodic_normalized_observation_space_limits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_observation_space_limits</span><span class="p">(</span><span class="n">include_all</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">periodic_normalization</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@action_space</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">action_space</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action_space</span><span class="p">:</span> <span class="n">spaces</span><span class="o">.</span><span class="n">Box</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__action_space</span> <span class="o">=</span> <span class="n">action_space</span>

    <span class="nd">@name</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uid</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">name</span>

    <span class="nd">@observation_space_limit_delta</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">observation_space_limit_delta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observation_space_limit_delta</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__observation_space_limit_delta</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="k">if</span> <span class="n">observation_space_limit_delta</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">observation_space_limit_delta</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;observation_space&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation_space</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">observation_space</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_observation_space</span><span class="p">(</span><span class="n">include_all</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="nd">@maximum_temperature_delta</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">maximum_temperature_delta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maximum_temperature_delta</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__maximum_temperature_delta</span> <span class="o">=</span> <span class="mf">20.0</span> <span class="k">if</span> <span class="n">maximum_temperature_delta</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">maximum_temperature_delta</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;observation_space&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation_space</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">observation_space</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_observation_space</span><span class="p">(</span><span class="n">include_all</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="nd">@demand_observation_limit_factor</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">demand_observation_limit_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">demand_observation_limit_factor</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__demand_observation_limit_factor</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="k">if</span> <span class="n">demand_observation_limit_factor</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">demand_observation_limit_factor</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;observation_space&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation_space</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">observation_space</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_observation_space</span><span class="p">(</span><span class="n">include_all</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="nd">@stochastic_power_outage_model</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">stochastic_power_outage_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stochastic_power_outage_model</span><span class="p">:</span> <span class="n">PowerOutage</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__stochastic_power_outage_model</span> <span class="o">=</span> <span class="n">PowerOutage</span><span class="p">()</span> <span class="k">if</span> <span class="n">stochastic_power_outage_model</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">stochastic_power_outage_model</span>

    <span class="nd">@simulate_power_outage</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">simulate_power_outage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simulate_power_outage</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__simulate_power_outage</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">simulate_power_outage</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">simulate_power_outage</span>

    <span class="nd">@stochastic_power_outage</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">stochastic_power_outage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stochastic_power_outage</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__stochastic_power_outage</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">stochastic_power_outage</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">stochastic_power_outage</span>

    <span class="nd">@Environment</span><span class="o">.</span><span class="n">random_seed</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">random_seed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">Environment</span><span class="o">.</span><span class="n">random_seed</span><span class="o">.</span><span class="n">fset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cooling_device</span><span class="o">.</span><span class="n">random_seed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">random_seed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="o">.</span><span class="n">random_seed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cooling_storage</span><span class="o">.</span><span class="n">random_seed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heating_storage</span><span class="o">.</span><span class="n">random_seed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">electrical_storage</span><span class="o">.</span><span class="n">random_seed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pv</span><span class="o">.</span><span class="n">random_seed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span>

    <span class="nd">@Environment</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">episode_tracker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">episode_tracker</span><span class="p">:</span> <span class="n">EpisodeTracker</span><span class="p">):</span>
        <span class="n">Environment</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">fset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">episode_tracker</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cooling_device</span><span class="o">.</span><span class="n">episode_tracker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">episode_tracker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="o">.</span><span class="n">episode_tracker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cooling_storage</span><span class="o">.</span><span class="n">episode_tracker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heating_storage</span><span class="o">.</span><span class="n">episode_tracker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dhw_storage</span><span class="o">.</span><span class="n">episode_tracker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">electrical_storage</span><span class="o">.</span><span class="n">episode_tracker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">non_shiftable_load_device</span><span class="o">.</span><span class="n">episode_tracker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pv</span><span class="o">.</span><span class="n">episode_tracker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span>

    <span class="nd">@Environment</span><span class="o">.</span><span class="n">time_step_ratio</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">time_step_ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_step_ratio</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">Environment</span><span class="o">.</span><span class="n">time_step_ratio</span><span class="o">.</span><span class="n">fset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_step_ratio</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cooling_device</span><span class="o">.</span><span class="n">time_step_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">time_step_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="o">.</span><span class="n">time_step_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cooling_storage</span><span class="o">.</span><span class="n">time_step_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heating_storage</span><span class="o">.</span><span class="n">time_step_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dhw_storage</span><span class="o">.</span><span class="n">time_step_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">electrical_storage</span><span class="o">.</span><span class="n">time_step_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">non_shiftable_load_device</span><span class="o">.</span><span class="n">time_step_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pv</span><span class="o">.</span><span class="n">time_step_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step_ratio</span>    

<div class="viewcode-block" id="Building.get_metadata">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.Building.get_metadata">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">n_years</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">episode_time_steps</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">seconds_per_time_step</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8760</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="o">**</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(),</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;observation_metadata&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation_metadata</span><span class="p">,</span>
            <span class="s1">&#39;action_metadata&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_metadata</span><span class="p">,</span>
            <span class="s1">&#39;maximum_temperature_delta&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">maximum_temperature_delta</span><span class="p">,</span>
            <span class="s1">&#39;cooling_device&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooling_device</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(),</span>
            <span class="s1">&#39;heating_device&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(),</span>
            <span class="s1">&#39;dhw_device&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(),</span>
            <span class="s1">&#39;non_shiftable_load_device&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_shiftable_load_device</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(),</span>
            <span class="s1">&#39;cooling_storage&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooling_storage</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(),</span>
            <span class="s1">&#39;heating_storage&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_storage</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(),</span>
            <span class="s1">&#39;dhw_storage&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_storage</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(),</span>
            <span class="s1">&#39;electrical_storage&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">electrical_storage</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(),</span>
            <span class="s1">&#39;pv&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pv</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(),</span>
            <span class="s1">&#39;annual_cooling_demand_estimate&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">cooling_demand</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">n_years</span><span class="p">,</span>
            <span class="s1">&#39;annual_heating_demand_estimate&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">heating_demand</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">n_years</span><span class="p">,</span>
            <span class="s1">&#39;annual_dhw_demand_estimate&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">dhw_demand</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">n_years</span><span class="p">,</span>
            <span class="s1">&#39;annual_non_shiftable_load_estimate&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">non_shiftable_load</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">n_years</span><span class="p">,</span>
            <span class="s1">&#39;annual_solar_generation_estimate&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pv</span><span class="o">.</span><span class="n">get_generation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">solar_generation</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">n_years</span><span class="p">,</span>
            <span class="s1">&#39;charging_constraints&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_charging_constraints_config</span><span class="p">,</span>
            <span class="s1">&#39;charger_phase_map&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_charger_phase_map</span><span class="p">,</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="Building.observations">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.Building.observations">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">observations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include_all</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">normalize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">periodic_normalization</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">check_limits</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Observations at current time step.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        include_all: bool, default: False,</span>
<span class="sd">            Whether to estimate for all observations as listed in `observation_metadata` or only those that are active.</span>
<span class="sd">        normalize : bool, default: False</span>
<span class="sd">            Whether to apply min-max normalization bounded between [0, 1].</span>
<span class="sd">        periodic_normalization: bool, default: False</span>
<span class="sd">            Whether to apply sine-cosine normalization to cyclic observations including hour, day_type and month.</span>
<span class="sd">        check_limits: bool, default: False</span>
<span class="sd">            Whether to check if observations are within observation space and if not, will send output to log describing </span>
<span class="sd">            out of bounds observations. Useful for agents that will fail if observations fall outside space e.g. RLlib agents.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        observation_space : spaces.Box</span>
<span class="sd">            Observation low and high limits.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Lower and upper bounds of net electricity consumption are rough estimates and may not be completely accurate hence,</span>
<span class="sd">        scaling this observation-variable using these bounds may result in normalized values above 1 or below 0.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">normalize</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">normalize</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">normalize</span>
        <span class="n">periodic_normalization</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">periodic_normalization</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">periodic_normalization</span>
        <span class="n">include_all</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">include_all</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">include_all</span>
        <span class="n">check_limits</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">check_limits</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">check_limits</span>

        <span class="n">observations</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_observations_data</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">include_all</span><span class="p">:</span>
            <span class="n">valid_observations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">active_observations</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">valid_observations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_observations</span>

        <span class="n">observations</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">valid_observations</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>

        <span class="n">observations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_ev_charger_observations</span><span class="p">(</span><span class="n">observations</span><span class="p">,</span> <span class="n">valid_observations</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">electric_vehicle_chargers</span><span class="p">)</span>

        <span class="n">observations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_washing_machine_observations</span><span class="p">(</span><span class="n">observations</span><span class="p">,</span> <span class="n">valid_observations</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">washing_machines</span><span class="p">)</span>

        <span class="n">unknown_observations</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">observations</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">valid_observations</span><span class="p">))</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">unknown_observations</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Unknown observations: </span><span class="si">{</span><span class="n">unknown_observations</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="n">non_periodic_low_limit</span><span class="p">,</span> <span class="n">non_periodic_high_limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_periodic_normalized_observation_space_limits</span>
        <span class="n">periodic_low_limit</span><span class="p">,</span> <span class="n">periodic_high_limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">periodic_normalized_observation_space_limits</span>
        <span class="n">periodic_observations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_periodic_observation_metadata</span><span class="p">()</span>


        <span class="k">if</span> <span class="n">check_limits</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_observations</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">observations</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="n">lower</span> <span class="o">=</span> <span class="n">non_periodic_low_limit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="n">upper</span> <span class="o">=</span> <span class="n">non_periodic_high_limit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">lower</span> <span class="o">&lt;=</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="n">upper</span><span class="p">:</span>
                    <span class="n">report</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;Building&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="s1">&#39;episode&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">episode</span><span class="p">,</span>
                        <span class="s1">&#39;time_step&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">episode_time_steps</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;observation&#39;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span>
                        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
                        <span class="s1">&#39;lower&#39;</span><span class="p">:</span> <span class="n">lower</span><span class="p">,</span>
                        <span class="s1">&#39;upper&#39;</span><span class="p">:</span> <span class="n">upper</span>
                    <span class="p">}</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Observation outside space limit: </span><span class="si">{</span><span class="n">report</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">if</span> <span class="n">periodic_normalization</span><span class="p">:</span>
            <span class="n">observations_copy</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">observations</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="n">observations</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">pn</span> <span class="o">=</span> <span class="n">PeriodicNormalization</span><span class="p">(</span><span class="n">x_max</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">observations_copy</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">periodic_observations</span><span class="p">:</span>
                    <span class="n">pn</span><span class="o">.</span><span class="n">x_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">periodic_observations</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                    <span class="n">sin_x</span><span class="p">,</span> <span class="n">cos_x</span> <span class="o">=</span> <span class="n">v</span> <span class="o">*</span> <span class="n">pn</span>
                    <span class="n">observations</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">_cos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cos_x</span>
                    <span class="n">observations</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">_sin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sin_x</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">observations</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
            <span class="n">nm</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">observations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">nm</span><span class="o">.</span><span class="n">x_min</span> <span class="o">=</span> <span class="n">periodic_low_limit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="n">nm</span><span class="o">.</span><span class="n">x_max</span> <span class="o">=</span> <span class="n">periodic_high_limit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="n">observations</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span> <span class="o">*</span> <span class="n">nm</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">return</span> <span class="n">observations</span></div>


<div class="viewcode-block" id="Building.update_ev_charger_observations">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.Building.update_ev_charger_observations">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_ev_charger_observations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observations</span><span class="p">,</span> <span class="n">valid_observations</span><span class="p">,</span> <span class="n">ev_chargers</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the observations for each electric vehicle charger using charger simulation data.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            observations (dict): Dictionary to populate with observation values.</span>
<span class="sd">            valid_observations (set or list): Allowed observation keys.</span>
<span class="sd">            ev_chargers (iterable): List of charger objects, each with:</span>
<span class="sd">                - charger_id</span>
<span class="sd">                - charger_simulation (ChargerSchedule)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">for</span> <span class="n">charger</span> <span class="ow">in</span> <span class="n">ev_chargers</span><span class="p">:</span>
            <span class="n">charger_id</span> <span class="o">=</span> <span class="n">charger</span><span class="o">.</span><span class="n">charger_id</span>
            <span class="n">sim</span> <span class="o">=</span> <span class="n">charger</span><span class="o">.</span><span class="n">charger_simulation</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span>

            <span class="c1"># Keys</span>
            <span class="n">connected_state_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;electric_vehicle_charger_</span><span class="si">{</span><span class="n">charger_id</span><span class="si">}</span><span class="s1">_connected_state&#39;</span>
            <span class="n">incoming_state_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;electric_vehicle_charger_</span><span class="si">{</span><span class="n">charger_id</span><span class="si">}</span><span class="s1">_incoming_state&#39;</span>
            <span class="n">departure_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;connected_electric_vehicle_at_charger_</span><span class="si">{</span><span class="n">charger_id</span><span class="si">}</span><span class="s1">_departure_time&#39;</span>
            <span class="n">req_soc_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;connected_electric_vehicle_at_charger_</span><span class="si">{</span><span class="n">charger_id</span><span class="si">}</span><span class="s1">_required_soc_departure&#39;</span>
            <span class="n">soc_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;connected_electric_vehicle_at_charger_</span><span class="si">{</span><span class="n">charger_id</span><span class="si">}</span><span class="s1">_soc&#39;</span>
            <span class="n">capacity_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;connected_electric_vehicle_at_charger_</span><span class="si">{</span><span class="n">charger_id</span><span class="si">}</span><span class="s1">_battery_capacity&#39;</span>
            <span class="n">arrival_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;incoming_electric_vehicle_at_charger_</span><span class="si">{</span><span class="n">charger_id</span><span class="si">}</span><span class="s1">_estimated_arrival_time&#39;</span>
            <span class="n">soc_arrival_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;incoming_electric_vehicle_at_charger_</span><span class="si">{</span><span class="n">charger_id</span><span class="si">}</span><span class="s1">_estimated_soc_arrival&#39;</span>

            <span class="c1"># Get current state</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">electric_vehicle_charger_state</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">electric_vehicle_charger_state</span><span class="p">)</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

            <span class="c1"># ---------------------------</span>
            <span class="c1"># Update Connected EV Section</span>
            <span class="c1"># ---------------------------</span>
            <span class="k">if</span> <span class="n">charger</span><span class="o">.</span><span class="n">connected_electric_vehicle</span> <span class="ow">and</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">connected_state_key</span> <span class="ow">in</span> <span class="n">valid_observations</span><span class="p">:</span>
                    <span class="n">observations</span><span class="p">[</span><span class="n">connected_state_key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">departure_key</span> <span class="ow">in</span> <span class="n">valid_observations</span><span class="p">:</span>
                    <span class="n">observations</span><span class="p">[</span><span class="n">departure_key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">electric_vehicle_departure_time</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">req_soc_key</span> <span class="ow">in</span> <span class="n">valid_observations</span><span class="p">:</span>
                    <span class="n">observations</span><span class="p">[</span><span class="n">req_soc_key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">electric_vehicle_required_soc_departure</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">soc_key</span> <span class="ow">in</span> <span class="n">valid_observations</span><span class="p">:</span>
                    <span class="n">observations</span><span class="p">[</span><span class="n">soc_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">charger</span><span class="o">.</span><span class="n">connected_electric_vehicle</span><span class="o">.</span><span class="n">battery</span><span class="o">.</span><span class="n">soc</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">capacity_key</span> <span class="ow">in</span> <span class="n">valid_observations</span><span class="p">:</span>
                    <span class="n">observations</span><span class="p">[</span><span class="n">capacity_key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">electric_vehicle_battery_capacity_kwh</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">connected_state_key</span> <span class="ow">in</span> <span class="n">valid_observations</span><span class="p">:</span>
                    <span class="n">observations</span><span class="p">[</span><span class="n">connected_state_key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">departure_key</span> <span class="ow">in</span> <span class="n">valid_observations</span><span class="p">:</span>
                    <span class="n">observations</span><span class="p">[</span><span class="n">departure_key</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">if</span> <span class="n">req_soc_key</span> <span class="ow">in</span> <span class="n">valid_observations</span><span class="p">:</span>
                    <span class="n">observations</span><span class="p">[</span><span class="n">req_soc_key</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1</span>
                <span class="k">if</span> <span class="n">soc_key</span> <span class="ow">in</span> <span class="n">valid_observations</span><span class="p">:</span>
                    <span class="n">observations</span><span class="p">[</span><span class="n">soc_key</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1</span>
                <span class="k">if</span> <span class="n">capacity_key</span> <span class="ow">in</span> <span class="n">valid_observations</span><span class="p">:</span>
                    <span class="n">observations</span><span class="p">[</span><span class="n">capacity_key</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

            <span class="c1"># ---------------------------</span>
            <span class="c1"># Update Incoming EV Section</span>
            <span class="c1"># ---------------------------</span>
            <span class="k">if</span> <span class="n">charger</span><span class="o">.</span><span class="n">incoming_electric_vehicle</span> <span class="ow">and</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">incoming_state_key</span> <span class="ow">in</span> <span class="n">valid_observations</span><span class="p">:</span>
                    <span class="n">observations</span><span class="p">[</span><span class="n">incoming_state_key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">arrival_key</span> <span class="ow">in</span> <span class="n">valid_observations</span><span class="p">:</span>
                    <span class="n">observations</span><span class="p">[</span><span class="n">arrival_key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">electric_vehicle_estimated_arrival_time</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">soc_arrival_key</span> <span class="ow">in</span> <span class="n">valid_observations</span><span class="p">:</span>
                    <span class="n">observations</span><span class="p">[</span><span class="n">soc_arrival_key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">electric_vehicle_estimated_soc_arrival</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">incoming_state_key</span> <span class="ow">in</span> <span class="n">valid_observations</span><span class="p">:</span>
                    <span class="n">observations</span><span class="p">[</span><span class="n">incoming_state_key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">arrival_key</span> <span class="ow">in</span> <span class="n">valid_observations</span><span class="p">:</span>
                    <span class="n">observations</span><span class="p">[</span><span class="n">arrival_key</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">if</span> <span class="n">soc_arrival_key</span> <span class="ow">in</span> <span class="n">valid_observations</span><span class="p">:</span>
                    <span class="n">observations</span><span class="p">[</span><span class="n">soc_arrival_key</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1</span>

        <span class="k">return</span> <span class="n">observations</span></div>

                
    
<div class="viewcode-block" id="Building.update_washing_machine_observations">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.Building.update_washing_machine_observations">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_washing_machine_observations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observations</span><span class="p">,</span> <span class="n">valid_observations</span><span class="p">,</span> <span class="n">washing_machines</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the observations for each washing machine.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            observations (dict): The dictionary to update with observation values.</span>
<span class="sd">            valid_observations (set or list): Collection of valid observation keys.</span>
<span class="sd">            washing_machines (iterable): List of washing machine objects. Each machine is expected to have:</span>
<span class="sd">                - name attribute</span>
<span class="sd">                - washing_machine_simulation attribute with wm_start_time_step and wm_end_time_step arrays</span>
<span class="sd">                - observations() method that returns a dictionary</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">wm</span> <span class="ow">in</span> <span class="n">washing_machines</span><span class="p">:</span>
            <span class="n">wm_name</span> <span class="o">=</span> <span class="n">wm</span><span class="o">.</span><span class="n">name</span>

            <span class="c1"># Get all observations from the washing machine</span>
            <span class="n">wm_obs</span> <span class="o">=</span> <span class="n">wm</span><span class="o">.</span><span class="n">observations</span><span class="p">()</span>
            
            <span class="c1"># Update start time if valid</span>
            <span class="n">start_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">wm_name</span><span class="si">}</span><span class="s1">_start_time_step&#39;</span>
            <span class="k">if</span> <span class="n">start_key</span> <span class="ow">in</span> <span class="n">valid_observations</span><span class="p">:</span>
                <span class="n">observations</span><span class="p">[</span><span class="n">start_key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">wm_obs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;_start_time_step&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">),</span>
                    <span class="o">-</span><span class="mi">1</span>  <span class="c1"># default value if not found</span>
                <span class="p">)</span>

            <span class="c1"># Update end time if valid</span>
            <span class="n">end_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">wm_name</span><span class="si">}</span><span class="s1">_end_time_step&#39;</span>
            <span class="k">if</span> <span class="n">end_key</span> <span class="ow">in</span> <span class="n">valid_observations</span><span class="p">:</span>
                <span class="n">observations</span><span class="p">[</span><span class="n">end_key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">wm_obs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;_end_time_step&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">),</span>
                    <span class="o">-</span><span class="mi">1</span>  <span class="c1"># default value if not found</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">observations</span></div>





    <span class="k">def</span><span class="w"> </span><span class="nf">_get_observations_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
        <span class="n">electric_vehicle_chargers_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">washing_machines_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">charger</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">electric_vehicle_chargers</span><span class="p">:</span>
            <span class="n">charger_id</span> <span class="o">=</span> <span class="n">charger</span><span class="o">.</span><span class="n">charger_id</span>
            <span class="n">connected_car</span> <span class="o">=</span> <span class="n">charger</span><span class="o">.</span><span class="n">connected_electric_vehicle</span>

            <span class="k">if</span> <span class="n">connected_car</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Use current timestep values to align rewards/observations with actions at t</span>
                <span class="c1"># Last charged energy for current timestep (0.0 if not set)</span>
                <span class="n">last_charged_kwh</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">charger</span><span class="o">.</span><span class="n">past_charging_action_values_kwh</span><span class="p">):</span>
                    <span class="n">last_charged_kwh</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">charger</span><span class="o">.</span><span class="n">past_charging_action_values_kwh</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">])</span>

                <span class="c1"># Current battery SOC after applying action at t</span>
                <span class="n">battery_soc</span> <span class="o">=</span> <span class="n">connected_car</span><span class="o">.</span><span class="n">battery</span><span class="o">.</span><span class="n">soc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span>

                <span class="c1"># Previous SOC (t-1) or initial at t=0</span>
                <span class="n">previous_battery_soc</span> <span class="o">=</span> <span class="n">connected_car</span><span class="o">.</span><span class="n">battery</span><span class="o">.</span><span class="n">initial_soc</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">connected_car</span><span class="o">.</span><span class="n">battery</span><span class="o">.</span><span class="n">soc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

                <span class="c1"># Schedule values at current timestep</span>
                <span class="n">required_soc</span> <span class="o">=</span> <span class="n">charger</span><span class="o">.</span><span class="n">charger_simulation</span><span class="o">.</span><span class="n">electric_vehicle_required_soc_departure</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span>
                <span class="n">hours_until_departure</span> <span class="o">=</span> <span class="n">charger</span><span class="o">.</span><span class="n">charger_simulation</span><span class="o">.</span><span class="n">electric_vehicle_departure_time</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span>

                <span class="n">battery_capacity</span> <span class="o">=</span> <span class="n">connected_car</span><span class="o">.</span><span class="n">battery</span><span class="o">.</span><span class="n">capacity</span>
                <span class="n">min_capacity</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">connected_car</span><span class="o">.</span><span class="n">battery</span><span class="o">.</span><span class="n">depth_of_discharge</span><span class="p">)</span> <span class="o">*</span> <span class="n">battery_capacity</span>

                <span class="n">electric_vehicle_chargers_dict</span><span class="p">[</span><span class="n">charger_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;connected&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s2">&quot;last_charged_kwh&quot;</span><span class="p">:</span> <span class="n">last_charged_kwh</span><span class="p">,</span>
                    <span class="s2">&quot;previous_battery_soc&quot;</span><span class="p">:</span> <span class="n">previous_battery_soc</span><span class="p">,</span>
                    <span class="s2">&quot;battery_soc&quot;</span><span class="p">:</span> <span class="n">battery_soc</span><span class="p">,</span>
                    <span class="s2">&quot;battery_capacity&quot;</span><span class="p">:</span> <span class="n">battery_capacity</span><span class="p">,</span>
                    <span class="s2">&quot;min_capacity&quot;</span><span class="p">:</span> <span class="n">min_capacity</span><span class="p">,</span>
                    <span class="s2">&quot;required_soc&quot;</span><span class="p">:</span> <span class="n">required_soc</span><span class="p">,</span>
                    <span class="s2">&quot;hours_until_departure&quot;</span><span class="p">:</span> <span class="n">hours_until_departure</span><span class="p">,</span>
                    <span class="s2">&quot;max_charging_power&quot;</span><span class="p">:</span> <span class="n">charger</span><span class="o">.</span><span class="n">max_charging_power</span><span class="p">,</span>
                    <span class="s2">&quot;max_discharging_power&quot;</span><span class="p">:</span> <span class="n">charger</span><span class="o">.</span><span class="n">max_discharging_power</span><span class="p">,</span>
                <span class="p">}</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">electric_vehicle_chargers_dict</span><span class="p">[</span><span class="n">charger_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;connected&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;last_charged_kwh&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s2">&quot;previous_battery_soc&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s2">&quot;battery_soc&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s2">&quot;battery_capacity&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s2">&quot;min_capacity&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s2">&quot;required_soc&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s2">&quot;hours_until_departure&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s2">&quot;max_charging_power&quot;</span><span class="p">:</span> <span class="n">charger</span><span class="o">.</span><span class="n">max_charging_power</span><span class="p">,</span>
                    <span class="s2">&quot;max_discharging_power&quot;</span><span class="p">:</span> <span class="n">charger</span><span class="o">.</span><span class="n">max_discharging_power</span><span class="p">,</span>
                <span class="p">}</span>

        <span class="k">for</span> <span class="n">wm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">washing_machines</span><span class="p">:</span>
            <span class="n">washing_machine_name</span> <span class="o">=</span> <span class="n">wm</span><span class="o">.</span><span class="n">name</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span>
            <span class="c1"># Use current timestep values; default to sentinel values if out of bounds</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">_safe</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">default</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">arr</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">default</span>

            <span class="n">start_time_step</span> <span class="o">=</span> <span class="n">_safe</span><span class="p">(</span><span class="n">wm</span><span class="o">.</span><span class="n">washing_machine_simulation</span><span class="o">.</span><span class="n">wm_start_time_step</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">end_time_step</span> <span class="o">=</span> <span class="n">_safe</span><span class="p">(</span><span class="n">wm</span><span class="o">.</span><span class="n">washing_machine_simulation</span><span class="o">.</span><span class="n">wm_end_time_step</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">load_profile</span> <span class="o">=</span> <span class="n">_safe</span><span class="p">(</span><span class="n">wm</span><span class="o">.</span><span class="n">washing_machine_simulation</span><span class="o">.</span><span class="n">load_profile</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

            <span class="n">washing_machines_dict</span><span class="p">[</span><span class="n">washing_machine_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;wm_start_time_step&quot;</span><span class="p">:</span> <span class="n">start_time_step</span><span class="p">,</span>
                <span class="s2">&quot;wm_end_time_step&quot;</span><span class="p">:</span> <span class="n">end_time_step</span><span class="p">,</span>
                <span class="s2">&quot;load_profile&quot;</span><span class="p">:</span> <span class="n">load_profile</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="n">observations</span> <span class="o">=</span> <span class="p">{</span>
            <span class="o">**</span><span class="p">{</span>
                <span class="n">k</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">))[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span> 
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
            <span class="p">},</span>
            <span class="o">**</span><span class="p">{</span>
                <span class="n">k</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">weather</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">))[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span> 
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weather</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
            <span class="p">},</span>
            <span class="o">**</span><span class="p">{</span>
                <span class="n">k</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">pricing</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">))[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span> 
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pricing</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
            <span class="p">},</span>
            <span class="o">**</span><span class="p">{</span>
                <span class="n">k</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">carbon_intensity</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">))[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span> 
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">carbon_intensity</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
            <span class="p">},</span>
            <span class="s1">&#39;solar_generation&#39;</span><span class="p">:</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solar_generation</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]),</span>
            <span class="o">**</span><span class="p">{</span>
                <span class="s1">&#39;cooling_storage_soc&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">cooling_storage</span><span class="o">.</span><span class="n">soc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">],</span>
                <span class="s1">&#39;heating_storage_soc&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">heating_storage</span><span class="o">.</span><span class="n">soc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">],</span>
                <span class="s1">&#39;dhw_storage_soc&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">dhw_storage</span><span class="o">.</span><span class="n">soc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">],</span>
                <span class="s1">&#39;electrical_storage_soc&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">electrical_storage</span><span class="o">.</span><span class="n">soc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">],</span>
            <span class="p">},</span>
            <span class="s1">&#39;cooling_demand&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__energy_from_cooling_device</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cooling_storage</span><span class="o">.</span><span class="n">energy_balance</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)),</span>
            <span class="s1">&#39;heating_demand&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__energy_from_heating_device</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heating_storage</span><span class="o">.</span><span class="n">energy_balance</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)),</span>
            <span class="s1">&#39;dhw_demand&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__energy_from_dhw_device</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dhw_storage</span><span class="o">.</span><span class="n">energy_balance</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)),</span>
            <span class="s1">&#39;net_electricity_consumption&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">net_electricity_consumption</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">],</span>
            <span class="s1">&#39;cooling_electricity_consumption&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooling_electricity_consumption</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">],</span>
            <span class="s1">&#39;heating_electricity_consumption&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_electricity_consumption</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">],</span>
            <span class="s1">&#39;dhw_electricity_consumption&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_electricity_consumption</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">],</span>
            <span class="s1">&#39;cooling_storage_electricity_consumption&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooling_storage_electricity_consumption</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">],</span>
            <span class="s1">&#39;heating_storage_electricity_consumption&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_storage_electricity_consumption</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">],</span>
            <span class="s1">&#39;dhw_storage_electricity_consumption&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_storage_electricity_consumption</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">],</span>
            <span class="s1">&#39;electrical_storage_electricity_consumption&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">electrical_storage_electricity_consumption</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">],</span>
            <span class="s1">&#39;washing_machine_electricity_consumption&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">washing_machines_electricity_consumption</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">],</span>
            <span class="s1">&#39;cooling_device_efficiency&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooling_device</span><span class="o">.</span><span class="n">get_cop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weather</span><span class="o">.</span><span class="n">outdoor_dry_bulb_temperature</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">],</span> <span class="n">heating</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
            <span class="s1">&#39;heating_device_efficiency&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">get_cop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weather</span><span class="o">.</span><span class="n">outdoor_dry_bulb_temperature</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">],</span> <span class="n">heating</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> \
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="p">,</span> <span class="n">HeatPump</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">efficiency</span><span class="p">,</span>
            <span class="s1">&#39;dhw_device_efficiency&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="o">.</span><span class="n">get_cop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weather</span><span class="o">.</span><span class="n">outdoor_dry_bulb_temperature</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">],</span> <span class="n">heating</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> \
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="p">,</span> <span class="n">HeatPump</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="o">.</span><span class="n">efficiency</span><span class="p">,</span>
            <span class="s1">&#39;indoor_dry_bulb_temperature_cooling_set_point&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">indoor_dry_bulb_temperature_cooling_set_point</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">],</span>
            <span class="s1">&#39;indoor_dry_bulb_temperature_heating_set_point&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">indoor_dry_bulb_temperature_heating_set_point</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">],</span>
            <span class="s1">&#39;indoor_dry_bulb_temperature_cooling_delta&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">indoor_dry_bulb_temperature</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">indoor_dry_bulb_temperature_cooling_set_point</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">],</span>
            <span class="s1">&#39;indoor_dry_bulb_temperature_heating_delta&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">indoor_dry_bulb_temperature</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">indoor_dry_bulb_temperature_heating_set_point</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">],</span>
            <span class="s1">&#39;comfort_band&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">comfort_band</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">],</span>
            <span class="s1">&#39;occupant_count&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">occupant_count</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">],</span>
            <span class="s1">&#39;power_outage&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__power_outage_signal</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">],</span>
            <span class="s1">&#39;electric_vehicles_chargers_dict&#39;</span><span class="p">:</span> <span class="n">electric_vehicle_chargers_dict</span><span class="p">,</span>
            <span class="s1">&#39;washing_machines_dict&#39;</span><span class="p">:</span> <span class="n">washing_machines_dict</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_charging_constraints_enabled&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_expose_charging_constraints&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_charging_constraints_state</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_charging_constraints_state</span>
            <span class="n">headroom</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;building_headroom_kw&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">headroom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">observations</span><span class="p">[</span><span class="s1">&#39;charging_building_headroom_kw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">headroom</span>
            <span class="k">for</span> <span class="n">phase_name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;phase_headroom_kw&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">observations</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;charging_phase_</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s1">_headroom_kw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_charging_constraints_enabled&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_expose_charging_violation&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">observations</span><span class="p">[</span><span class="s1">&#39;charging_constraint_violation_kwh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_charging_constraint_last_penalty_kwh</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_phase_encoding_observations&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">observations</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_encoding_observations</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">observations</span>
    
<div class="viewcode-block" id="Building.get_periodic_observation_metadata">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.Building.get_periodic_observation_metadata">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_periodic_observation_metadata</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Get periodic observation names and their minimum and maximum values for periodic/cyclic normalization.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        periodic_observation_metadata: Mapping[str, int]</span>
<span class="sd">            Observation low and high limits.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;hour&#39;</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
            <span class="s1">&#39;day_type&#39;</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
            <span class="s1">&#39;month&#39;</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">),</span>
            <span class="s1">&#39;minutes&#39;</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">61</span><span class="p">)</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="Building.apply_actions">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.Building.apply_actions">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">apply_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">cooling_or_heating_device_action</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cooling_device_action</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">heating_device_action</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cooling_storage_action</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">heating_storage_action</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dhw_storage_action</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">electrical_storage_action</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">washing_machine_actions</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">electric_vehicle_storage_actions</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Update cooling and heating demand for next timestep and charge/discharge storage devices.</span>

<span class="sd">        The order of action execution is dependent on polarity of the storage actions. If the electrical </span>
<span class="sd">        storage is to be discharged, its action is executed first before all other actions. Likewise, if </span>
<span class="sd">        the storage for an end-use is to be discharged, the storage action is executed before the control </span>
<span class="sd">        action for the end-use electric device. Discharging the storage devices before fulfilling thermal </span>
<span class="sd">        and non-shiftable loads ensures that the discharged energy is considered when allocating electricity </span>
<span class="sd">        consumption to meet building loads. Likewise, meeting building loads before charging storage devices </span>
<span class="sd">        ensures that comfort is met before attempting to shift loads.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cooling_or_heating_device_action : float, default: np.nan</span>
<span class="sd">            Fraction of `cooling_device` or `heating_device` `nominal_power` to make available. An action </span>
<span class="sd">            &lt; 0.0 is for the `cooling_device`, while an action &gt; 0.0 is for the `heating_device`.</span>
<span class="sd">        cooling_device_action : float, default: np.nan</span>
<span class="sd">            Fraction of `cooling_device` `nominal_power` to make available for space cooling.</span>
<span class="sd">        heating_device_action : float, default: np.nan</span>
<span class="sd">            Fraction of `heating_device` `nominal_power` to make available for space heating.</span>
<span class="sd">        cooling_storage_action : float, default: 0.0</span>
<span class="sd">            Fraction of `cooling_storage` `capacity` to charge/discharge by.</span>
<span class="sd">        heating_storage_action : float, default: 0.0</span>
<span class="sd">            Fraction of `heating_storage` `capacity` to charge/discharge by.</span>
<span class="sd">        dhw_storage_action : float, default: 0.0</span>
<span class="sd">            Fraction of `dhw_storage` `capacity` to charge/discharge by.</span>
<span class="sd">        electrical_storage_action : float, default: 0.0</span>
<span class="sd">            Fraction of `electrical_storage` `nominal power` to charge/discharge by.</span>
<span class="sd">        electric_vehicle_storage_actions : dict, default: None</span>
<span class="sd">            A dictionary where keys are charger IDs and values are the fraction of connected EV battery `capacity`</span>
<span class="sd">        **kwargs</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">electric_vehicle_storage_actions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">electric_vehicle_storage_actions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_charging_constraints_to_actions</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">electric_vehicle_storage_actions</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_apply_charging_constraints_to_actions</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

        <span class="c1"># hvac devices</span>
        <span class="k">if</span> <span class="s1">&#39;cooling_or_heating_device&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_actions</span><span class="p">:</span>
            <span class="k">assert</span> <span class="s1">&#39;cooling_device&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_actions</span> <span class="ow">and</span> <span class="s1">&#39;heating_device&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_actions</span><span class="p">,</span> \
                <span class="s1">&#39;cooling_device and heating_device actions must be set to False when cooling_or_heating_device is True.&#39;</span> \
                    <span class="s1">&#39; They will be implicitly set based on the polarity of cooling_or_heating_device.&#39;</span>
            <span class="n">cooling_device_action</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">cooling_or_heating_device_action</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
            <span class="n">heating_device_action</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">cooling_or_heating_device_action</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="s1">&#39;cooling_device&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_actions</span> <span class="ow">and</span> <span class="s1">&#39;heating_device&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_actions</span><span class="p">),</span> \
                <span class="s1">&#39;cooling_device and heating_device actions cannot both be set to True to avoid both actions having&#39;</span> \
                    <span class="s1">&#39; values &gt; 0.0 in the same time step. Use cooling_or_heating_device action instead to control&#39;</span> \
                        <span class="s1">&#39; both cooling_device and heating_device in a building.&#39;</span>
            <span class="n">cooling_device_action</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">if</span> <span class="s1">&#39;cooling_device&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_actions</span> <span class="k">else</span> <span class="n">cooling_device_action</span>
            <span class="n">heating_device_action</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">if</span> <span class="s1">&#39;heating_device&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_actions</span> <span class="k">else</span> <span class="n">heating_device_action</span>

        <span class="c1"># energy storage devices</span>
        <span class="n">cooling_storage_action</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="k">if</span> <span class="s1">&#39;cooling_storage&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_actions</span> <span class="k">else</span> <span class="n">cooling_storage_action</span>
        <span class="n">heating_storage_action</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="k">if</span> <span class="s1">&#39;heating_storage&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_actions</span> <span class="k">else</span> <span class="n">heating_storage_action</span>
        <span class="n">dhw_storage_action</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="k">if</span> <span class="s1">&#39;dhw_storage&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_actions</span> <span class="k">else</span> <span class="n">dhw_storage_action</span>
        <span class="n">electrical_storage_action</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="k">if</span> <span class="s1">&#39;electrical_storage&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_actions</span> <span class="k">else</span> <span class="n">electrical_storage_action</span>

        <span class="c1"># set action priority</span>
        <span class="n">actions</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;cooling_demand&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_cooling_demand</span><span class="p">,</span> <span class="p">(</span><span class="n">cooling_device_action</span><span class="p">,)),</span>
            <span class="s1">&#39;heating_demand&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_heating_demand</span><span class="p">,</span> <span class="p">(</span><span class="n">heating_device_action</span><span class="p">,)),</span>
            <span class="s1">&#39;cooling_device&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_energy_from_cooling_device</span><span class="p">,</span> <span class="p">()),</span>
            <span class="s1">&#39;cooling_storage&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_cooling_storage</span><span class="p">,</span> <span class="p">(</span><span class="n">cooling_storage_action</span><span class="p">,)),</span>
            <span class="s1">&#39;heating_device&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_energy_from_heating_device</span><span class="p">,</span> <span class="p">()),</span>
            <span class="s1">&#39;heating_storage&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_heating_storage</span><span class="p">,</span> <span class="p">(</span><span class="n">heating_storage_action</span><span class="p">,)),</span>
            <span class="s1">&#39;dhw_device&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_energy_from_dhw_device</span><span class="p">,</span> <span class="p">()),</span>
            <span class="s1">&#39;dhw_storage&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_dhw_storage</span><span class="p">,</span> <span class="p">(</span><span class="n">dhw_storage_action</span><span class="p">,)),</span>
            <span class="s1">&#39;non_shiftable_load&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_non_shiftable_load</span><span class="p">,</span> <span class="p">()),</span>
            <span class="s1">&#39;electrical_storage&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_electrical_storage</span><span class="p">,</span> <span class="p">(</span><span class="n">electrical_storage_action</span><span class="p">,)),</span>
        <span class="p">}</span>

        <span class="n">priority_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">actions</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">electric_vehicle_storage_actions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">electric_vehicle_priority_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">charger_id</span><span class="p">,</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">electric_vehicle_storage_actions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">action_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;electric_vehicle_storage_</span><span class="si">{</span><span class="n">charger_id</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="k">if</span> <span class="n">action_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_actions</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;This action should not be applied. Verify&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">charger</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">electric_vehicle_chargers</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">charger</span><span class="o">.</span><span class="n">charger_id</span> <span class="o">==</span> <span class="n">charger_id</span><span class="p">:</span>
                        <span class="n">actions</span><span class="p">[</span><span class="n">action_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">charger</span><span class="o">.</span><span class="n">update_connected_electric_vehicle_soc</span><span class="p">,</span> <span class="p">(</span><span class="n">action</span><span class="p">,))</span>
                        <span class="n">electric_vehicle_priority_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">action_key</span><span class="p">)</span>
            <span class="n">priority_list</span> <span class="o">=</span> <span class="n">priority_list</span> <span class="o">+</span> <span class="n">electric_vehicle_priority_list</span>  <span class="c1"># the priority lists are merged</span>

        <span class="k">if</span> <span class="n">washing_machine_actions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">washing_machine_priority_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">washing_machine_name</span><span class="p">,</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">washing_machine_actions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">action_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">washing_machine_name</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="k">if</span> <span class="n">action_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_actions</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;This action should not be applied. Verify&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">wm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">washing_machines</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">wm</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">washing_machine_name</span><span class="p">:</span>
                        <span class="n">actions</span><span class="p">[</span><span class="n">action_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">wm</span><span class="o">.</span><span class="n">start_cycle</span><span class="p">,</span> <span class="p">(</span><span class="n">action</span><span class="p">,))</span>
                        <span class="n">washing_machine_priority_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">action_key</span><span class="p">)</span>
            <span class="n">priority_list</span> <span class="o">=</span> <span class="n">priority_list</span> <span class="o">+</span> <span class="n">washing_machine_priority_list</span>

        <span class="k">if</span> <span class="n">electrical_storage_action</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;electrical_storage&#39;</span>
            <span class="n">priority_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">priority_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+</span> <span class="n">priority_list</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cooling&#39;</span><span class="p">,</span> <span class="s1">&#39;heating&#39;</span><span class="p">,</span> <span class="s1">&#39;dhw&#39;</span><span class="p">]:</span>
            <span class="n">storage</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">_storage&#39;</span>
            <span class="n">device</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">_device&#39;</span>

            <span class="k">if</span> <span class="n">actions</span><span class="p">[</span><span class="n">storage</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">storage_ix</span> <span class="o">=</span> <span class="n">priority_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">storage</span><span class="p">)</span>
                <span class="n">device_ix</span> <span class="o">=</span> <span class="n">priority_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
                <span class="n">priority_list</span><span class="p">[</span><span class="n">storage_ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">device</span>
                <span class="n">priority_list</span><span class="p">[</span><span class="n">device_ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">storage</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">priority_list</span><span class="p">:</span>
            <span class="n">func</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">actions</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>
                <span class="k">pass</span></div>


<div class="viewcode-block" id="Building.update_cooling_demand">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.Building.update_cooling_demand">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_cooling_demand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update space cooling demand for current time step.&quot;&quot;&quot;</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


<div class="viewcode-block" id="Building.update_energy_from_cooling_device">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.Building.update_energy_from_cooling_device">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_energy_from_cooling_device</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Update cooling device electricity consumption and energy tranfer for current time step&#39;s cooling demand.&quot;&quot;&quot;</span>

        <span class="n">demand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooling_demand</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span>
        <span class="n">temperature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weather</span><span class="o">.</span><span class="n">outdoor_dry_bulb_temperature</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span>
        <span class="n">storage_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_from_cooling_storage</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span>
        <span class="n">max_electric_power</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">downward_electrical_flexibility</span>
        <span class="n">max_device_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooling_device</span><span class="o">.</span><span class="n">get_max_output_power</span><span class="p">(</span><span class="n">temperature</span><span class="p">,</span> <span class="n">heating</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_electric_power</span><span class="o">=</span><span class="n">max_electric_power</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">___demand_limit_check</span><span class="p">(</span><span class="s1">&#39;cooling&#39;</span><span class="p">,</span> <span class="n">demand</span><span class="p">,</span> <span class="n">max_device_output</span><span class="p">)</span>
        <span class="n">device_output</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">demand</span> <span class="o">-</span> <span class="n">storage_output</span><span class="p">,</span> <span class="n">max_device_output</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__energy_from_cooling_device</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span> <span class="o">=</span> <span class="n">device_output</span>
        <span class="n">electricity_consumption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooling_device</span><span class="o">.</span><span class="n">get_input_power</span><span class="p">(</span><span class="n">device_output</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">heating</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># LOGGER.debug(</span>
        <span class="c1">#     &#39;timestep:&#39;, self.time_step, &#39;bldg:&#39;, self.name, &#39;demand:&#39;, demand, &#39;temperature:&#39;, temperature, </span>
        <span class="c1">#     &#39;storage_capacity:&#39;, self.cooling_storage.capacity, &#39;prev_soc:&#39;, self.cooling_storage.soc[self.time_step - 1], </span>
        <span class="c1">#     &#39;curr_soc:&#39;, self.cooling_storage.soc[self.time_step], &#39;storage_output:&#39;, storage_output, </span>
        <span class="c1">#     &#39;max_electric_power:&#39;, max_electric_power, &#39;max_device_output:&#39;, max_device_output, &#39;device_output:&#39;, </span>
        <span class="c1">#     device_output, &#39;consumption:&#39;, electricity_consumption</span>
        <span class="c1"># )</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">___electricity_consumption_polarity_check</span><span class="p">(</span><span class="s1">&#39;cooling&#39;</span><span class="p">,</span> <span class="n">device_output</span><span class="p">,</span> <span class="n">electricity_consumption</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cooling_device</span><span class="o">.</span><span class="n">update_electricity_consumption</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">electricity_consumption</span><span class="p">))</span></div>


<div class="viewcode-block" id="Building.update_cooling_storage">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.Building.update_cooling_storage">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_cooling_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Charge/discharge `cooling_storage` for current time step.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        action: float</span>
<span class="sd">            Fraction of `cooling_storage` `capacity` to charge/discharge by.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">energy</span> <span class="o">=</span> <span class="n">action</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooling_storage</span><span class="o">.</span><span class="n">capacity</span>
        <span class="n">temperature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weather</span><span class="o">.</span><span class="n">outdoor_dry_bulb_temperature</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">energy</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">max_electric_power</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">downward_electrical_flexibility</span>
            <span class="n">max_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooling_device</span><span class="o">.</span><span class="n">get_max_output_power</span><span class="p">(</span><span class="n">temperature</span><span class="p">,</span> <span class="n">heating</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_electric_power</span><span class="o">=</span><span class="n">max_electric_power</span><span class="p">)</span>
            <span class="n">energy</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_output</span><span class="p">,</span> <span class="n">energy</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">demand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooling_demand</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span>
            <span class="n">energy</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="o">-</span><span class="n">demand</span><span class="p">,</span> <span class="n">energy</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cooling_storage</span><span class="o">.</span><span class="n">charge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_convert_energy_for_storage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cooling_storage</span><span class="p">,</span> <span class="n">energy</span><span class="p">))</span>
        <span class="n">charged_energy</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cooling_storage</span><span class="o">.</span><span class="n">energy_balance</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">electricity_consumption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooling_device</span><span class="o">.</span><span class="n">get_input_power</span><span class="p">(</span><span class="n">charged_energy</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">heating</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cooling_device</span><span class="o">.</span><span class="n">update_electricity_consumption</span><span class="p">(</span><span class="n">electricity_consumption</span><span class="p">)</span></div>


<div class="viewcode-block" id="Building.update_heating_demand">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.Building.update_heating_demand">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_heating_demand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update space heating demand for current time step.&quot;&quot;&quot;</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


<div class="viewcode-block" id="Building.update_energy_from_heating_device">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.Building.update_energy_from_heating_device">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_energy_from_heating_device</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Update heating device electricity consumption and energy tranfer for current time step&#39;s heating demand.&quot;&quot;&quot;</span>

        <span class="n">demand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_demand</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span>
        <span class="n">temperature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weather</span><span class="o">.</span><span class="n">outdoor_dry_bulb_temperature</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span>
        <span class="n">storage_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_from_heating_storage</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span>
        <span class="n">max_electric_power</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">downward_electrical_flexibility</span>
        <span class="n">max_device_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">get_max_output_power</span><span class="p">(</span><span class="n">temperature</span><span class="p">,</span> <span class="n">heating</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_electric_power</span><span class="o">=</span><span class="n">max_electric_power</span><span class="p">)</span> \
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="p">,</span> <span class="n">HeatPump</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">get_max_output_power</span><span class="p">(</span><span class="n">max_electric_power</span><span class="o">=</span><span class="n">max_electric_power</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">___demand_limit_check</span><span class="p">(</span><span class="s1">&#39;heating&#39;</span><span class="p">,</span> <span class="n">demand</span><span class="p">,</span> <span class="n">max_device_output</span><span class="p">)</span>
        <span class="n">device_output</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">demand</span> <span class="o">-</span> <span class="n">storage_output</span><span class="p">,</span> <span class="n">max_device_output</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__energy_from_heating_device</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span> <span class="o">=</span> <span class="n">device_output</span>
        <span class="n">electricity_consumption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">get_input_power</span><span class="p">(</span><span class="n">device_output</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">heating</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> \
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="p">,</span> <span class="n">HeatPump</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">get_input_power</span><span class="p">(</span><span class="n">device_output</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">___electricity_consumption_polarity_check</span><span class="p">(</span><span class="s1">&#39;heating&#39;</span><span class="p">,</span> <span class="n">device_output</span><span class="p">,</span> <span class="n">electricity_consumption</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">update_electricity_consumption</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">electricity_consumption</span><span class="p">))</span></div>


<div class="viewcode-block" id="Building.update_heating_storage">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.Building.update_heating_storage">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_heating_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Charge/discharge `heating_storage` for current time step.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        action: float</span>
<span class="sd">            Fraction of `heating_storage` `capacity` to charge/discharge by.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">energy</span> <span class="o">=</span> <span class="n">action</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooling_storage</span><span class="o">.</span><span class="n">capacity</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm_action_based_time_step_hours_ratio</span>
        <span class="n">temperature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weather</span><span class="o">.</span><span class="n">outdoor_dry_bulb_temperature</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">energy</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">max_electric_power</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">downward_electrical_flexibility</span>
            <span class="n">max_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">get_max_output_power</span><span class="p">(</span><span class="n">temperature</span><span class="p">,</span> <span class="n">heating</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_electric_power</span><span class="o">=</span><span class="n">max_electric_power</span><span class="p">)</span> \
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="p">,</span> <span class="n">HeatPump</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">get_max_output_power</span><span class="p">(</span><span class="n">max_electric_power</span><span class="o">=</span><span class="n">max_electric_power</span><span class="p">)</span>
            <span class="n">energy</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_output</span><span class="p">,</span> <span class="n">energy</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">demand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_demand</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span>
            <span class="n">energy</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="o">-</span><span class="n">demand</span><span class="p">,</span> <span class="n">energy</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">heating_storage</span><span class="o">.</span><span class="n">charge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_convert_energy_for_storage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heating_storage</span><span class="p">,</span> <span class="n">energy</span><span class="p">))</span>
        <span class="n">charged_energy</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heating_storage</span><span class="o">.</span><span class="n">energy_balance</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">electricity_consumption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">get_input_power</span><span class="p">(</span><span class="n">charged_energy</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">heating</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> \
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="p">,</span> <span class="n">HeatPump</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">get_input_power</span><span class="p">(</span><span class="n">charged_energy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">update_electricity_consumption</span><span class="p">(</span><span class="n">electricity_consumption</span><span class="p">)</span></div>


<div class="viewcode-block" id="Building.update_energy_from_dhw_device">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.Building.update_energy_from_dhw_device">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_energy_from_dhw_device</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Update dhw device electricity consumption and energy tranfer for current time step&#39;s dhw demand.&quot;&quot;&quot;</span>

        <span class="n">demand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_demand</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span>
        <span class="n">temperature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weather</span><span class="o">.</span><span class="n">outdoor_dry_bulb_temperature</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span>
        <span class="n">storage_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_from_dhw_storage</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span>
        <span class="n">max_electric_power</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">downward_electrical_flexibility</span>
        <span class="n">max_device_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="o">.</span><span class="n">get_max_output_power</span><span class="p">(</span><span class="n">temperature</span><span class="p">,</span> <span class="n">heating</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_electric_power</span><span class="o">=</span><span class="n">max_electric_power</span><span class="p">)</span> \
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="p">,</span> <span class="n">HeatPump</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="o">.</span><span class="n">get_max_output_power</span><span class="p">(</span><span class="n">max_electric_power</span><span class="o">=</span><span class="n">max_electric_power</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">___demand_limit_check</span><span class="p">(</span><span class="s1">&#39;dhw&#39;</span><span class="p">,</span> <span class="n">demand</span><span class="p">,</span> <span class="n">max_device_output</span><span class="p">)</span>
        <span class="n">device_output</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">demand</span> <span class="o">-</span> <span class="n">storage_output</span><span class="p">,</span> <span class="n">max_device_output</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__energy_from_dhw_device</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span> <span class="o">=</span> <span class="n">device_output</span>
        <span class="n">electricity_consumption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="o">.</span><span class="n">get_input_power</span><span class="p">(</span><span class="n">device_output</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">heating</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> \
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="p">,</span> <span class="n">HeatPump</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="o">.</span><span class="n">get_input_power</span><span class="p">(</span><span class="n">device_output</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">___electricity_consumption_polarity_check</span><span class="p">(</span><span class="s1">&#39;dhw&#39;</span><span class="p">,</span> <span class="n">device_output</span><span class="p">,</span> <span class="n">electricity_consumption</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="o">.</span><span class="n">update_electricity_consumption</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">electricity_consumption</span><span class="p">))</span></div>


<div class="viewcode-block" id="Building.update_dhw_storage">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.Building.update_dhw_storage">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_dhw_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Charge/discharge `dhw_storage` for current time step.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        action: float</span>
<span class="sd">            Fraction of `dhw_storage` `capacity` to charge/discharge by.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">energy</span> <span class="o">=</span> <span class="n">action</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_storage</span><span class="o">.</span><span class="n">capacity</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm_action_based_time_step_hours_ratio</span>
        <span class="n">temperature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weather</span><span class="o">.</span><span class="n">outdoor_dry_bulb_temperature</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">energy</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">max_electric_power</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">downward_electrical_flexibility</span>
            <span class="n">max_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="o">.</span><span class="n">get_max_output_power</span><span class="p">(</span><span class="n">temperature</span><span class="p">,</span> <span class="n">heating</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_electric_power</span><span class="o">=</span><span class="n">max_electric_power</span><span class="p">)</span> \
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="p">,</span> <span class="n">HeatPump</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="o">.</span><span class="n">get_max_output_power</span><span class="p">(</span><span class="n">max_electric_power</span><span class="o">=</span><span class="n">max_electric_power</span><span class="p">)</span>
            <span class="n">energy</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_output</span><span class="p">,</span> <span class="n">energy</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">demand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_demand</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span>
            <span class="n">energy</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="o">-</span><span class="n">demand</span><span class="p">,</span> <span class="n">energy</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dhw_storage</span><span class="o">.</span><span class="n">charge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_convert_energy_for_storage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dhw_storage</span><span class="p">,</span> <span class="n">energy</span><span class="p">))</span>
        <span class="n">charged_energy</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dhw_storage</span><span class="o">.</span><span class="n">energy_balance</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">electricity_consumption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="o">.</span><span class="n">get_input_power</span><span class="p">(</span><span class="n">charged_energy</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">heating</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> \
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="p">,</span> <span class="n">HeatPump</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="o">.</span><span class="n">get_input_power</span><span class="p">(</span><span class="n">charged_energy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="o">.</span><span class="n">update_electricity_consumption</span><span class="p">(</span><span class="n">electricity_consumption</span><span class="p">)</span></div>


<div class="viewcode-block" id="Building.update_non_shiftable_load">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.Building.update_non_shiftable_load">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_non_shiftable_load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Update non shiftable loads electricity consumption for current time step non shiftable load.&quot;&quot;&quot;</span>

        <span class="n">demand</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">non_shiftable_load</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">downward_electrical_flexibility</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__energy_to_non_shiftable_load</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span> <span class="o">=</span> <span class="n">demand</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">non_shiftable_load_device</span><span class="o">.</span><span class="n">update_electricity_consumption</span><span class="p">(</span><span class="n">demand</span><span class="p">)</span></div>


<div class="viewcode-block" id="Building.update_electrical_storage">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.Building.update_electrical_storage">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_electrical_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Charge/discharge the electrical storage (BESS) for the current time step.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        action : float</span>
<span class="sd">            Normalized charging or discharging action (range [-1, 1]).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Convert normalized action to power (kW)</span>
        <span class="n">power</span> <span class="o">=</span> <span class="n">action</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">electrical_storage</span><span class="o">.</span><span class="n">nominal_power</span>  <span class="c1"># kW</span>

        <span class="c1"># Convert power (kW) to energy (kWh) based on time step duration</span>
        <span class="n">time_step_hours_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seconds_per_time_step</span> <span class="o">/</span> <span class="mi">3600</span>  <span class="c1"># Convert seconds to fraction of hour</span>
        <span class="n">energy</span> <span class="o">=</span> <span class="n">power</span> <span class="o">*</span> <span class="n">time_step_hours_ratio</span>  <span class="c1"># Energy in kWh</span>

        <span class="c1"># Optionally clamp to flexibility range if needed</span>
        <span class="n">energy</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">energy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">downward_electrical_flexibility</span><span class="p">)</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">electrical_storage</span><span class="o">.</span><span class="n">charge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_convert_energy_for_storage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">electrical_storage</span><span class="p">,</span> <span class="n">energy</span><span class="p">))</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_convert_energy_for_storage</span><span class="p">(</span><span class="n">storage</span><span class="p">:</span> <span class="n">StorageDevice</span><span class="p">,</span> <span class="n">energy</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert energy for storage models that expect dataset-resolution values.&quot;&quot;&quot;</span>

        <span class="n">ratio</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">storage</span><span class="p">,</span> <span class="s1">&#39;time_step_ratio&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ratio</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">energy</span>

        <span class="k">return</span> <span class="n">energy</span> <span class="o">/</span> <span class="n">ratio</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">___demand_limit_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">end_use</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">demand</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">max_device_output</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;timestep: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="si">}</span><span class="s1">, building: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">, outage: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">power_outage</span><span class="si">}</span><span class="s1">, demand: </span><span class="si">{</span><span class="n">demand</span><span class="si">}</span><span class="s1">,&#39;</span> \
            <span class="sa">f</span><span class="s1">&#39;output: </span><span class="si">{</span><span class="n">max_device_output</span><span class="si">}</span><span class="s1">, difference: </span><span class="si">{</span><span class="n">demand</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">max_device_output</span><span class="si">}</span><span class="s1">, check: </span><span class="si">{</span><span class="n">demand</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">max_device_output</span><span class="si">}</span><span class="s1">,&#39;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_outage</span> <span class="ow">or</span> <span class="n">demand</span> <span class="o">&lt;=</span> <span class="n">max_device_output</span> <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">demand</span> <span class="o">-</span> <span class="n">max_device_output</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">TOLERANCE</span><span class="p">,</span> \
            <span class="sa">f</span><span class="s1">&#39;demand is greater than </span><span class="si">{</span><span class="n">end_use</span><span class="si">}</span><span class="s1">_device max output | </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s1">&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">___electricity_consumption_polarity_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">end_use</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">device_output</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">electricity_consumption</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;timestep: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="si">}</span><span class="s1">, building: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">, device_output: </span><span class="si">{</span><span class="n">device_output</span><span class="si">}</span><span class="s1">, electricity_consumption: </span><span class="si">{</span><span class="n">electricity_consumption</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">assert</span> <span class="n">electricity_consumption</span> <span class="o">&gt;=</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">electricity_consumption</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">TOLERANCE</span><span class="p">,</span> \
            <span class="sa">f</span><span class="s1">&#39;negative electricity consumption for </span><span class="si">{</span><span class="n">end_use</span><span class="si">}</span><span class="s1"> demand | </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s1">&#39;</span>

<div class="viewcode-block" id="Building.estimate_observation_space">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.Building.estimate_observation_space">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">estimate_observation_space</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include_all</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">normalize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">spaces</span><span class="o">.</span><span class="n">Box</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Get estimate of observation spaces.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        include_all: bool, default: False,</span>
<span class="sd">            Whether to estimate for all observations as listed in `observation_metadata` or only those that are active.</span>
<span class="sd">        normalize : bool, default: False</span>
<span class="sd">            Whether to apply min-max normalization bounded between [0, 1].</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        observation_space : spaces.Box</span>
<span class="sd">            Observation low and high limits.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">normalize</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">normalize</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">normalize</span>
        <span class="n">normalized_observation_space_limits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_observation_space_limits</span><span class="p">(</span><span class="n">include_all</span><span class="o">=</span><span class="n">include_all</span><span class="p">,</span> <span class="n">periodic_normalization</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">unnormalized_observation_space_limits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_observation_space_limits</span><span class="p">(</span><span class="n">include_all</span><span class="o">=</span><span class="n">include_all</span><span class="p">,</span> <span class="n">periodic_normalization</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
            <span class="n">low_limit</span><span class="p">,</span> <span class="n">high_limit</span> <span class="o">=</span> <span class="n">normalized_observation_space_limits</span>
            <span class="n">low_limit</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">low_limit</span><span class="p">)</span>
            <span class="n">high_limit</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">high_limit</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">low_limit</span><span class="p">,</span> <span class="n">high_limit</span> <span class="o">=</span> <span class="n">unnormalized_observation_space_limits</span>
            <span class="n">low_limit</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">low_limit</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">high_limit</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">high_limit</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">spaces</span><span class="o">.</span><span class="n">Box</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">low_limit</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">),</span> <span class="n">high</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">high_limit</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Building.estimate_observation_space_limits">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.Building.estimate_observation_space_limits">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">estimate_observation_space_limits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include_all</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">periodic_normalization</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span>
        <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Get estimate of observation space limits.</span>

<span class="sd">        Find minimum and maximum possible values of all the observations, which can then be used by the RL agent to scale the observations </span>
<span class="sd">        and train any function approximators more effectively.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        include_all: bool, default: False,</span>
<span class="sd">            Whether to estimate for all observations as listed in `observation_metadata` or only those that are active.</span>
<span class="sd">        periodic_normalization: bool, default: False</span>
<span class="sd">            Whether to apply sine-cosine normalization to cyclic observations including hour, day_type and month.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        observation_space_limits : Tuple[Mapping[str, float], Mapping[str, float]]</span>
<span class="sd">            Observation low and high limits.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Lower and upper bounds of net electricity consumption are rough estimates and may not be completely accurate hence,</span>
<span class="sd">        scaling this observation-variable using these bounds may result in normalized values above 1 or below 0. It is also</span>
<span class="sd">        assumed that devices and storage systems have been sized.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">include_all</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">include_all</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">include_all</span>
        <span class="n">internal_limit_observations</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;net_electricity_consumption_without_storage&#39;</span><span class="p">,</span>
            <span class="s1">&#39;net_electricity_consumption_without_storage_and_partial_load&#39;</span><span class="p">,</span>
            <span class="s1">&#39;net_electricity_consumption_without_storage_and_partial_load_and_pv&#39;</span>
        <span class="p">]</span>
        <span class="n">observation_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">observation_metadata</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="n">internal_limit_observations</span> <span class="k">if</span> <span class="n">include_all</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_observations</span>
        <span class="n">periodic_normalization</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">periodic_normalization</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">periodic_normalization</span>
        <span class="n">periodic_observations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_periodic_observation_metadata</span><span class="p">()</span>
        <span class="n">low_limit</span><span class="p">,</span> <span class="n">high_limit</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_observation_space_limits_data</span><span class="p">()</span>
        <span class="n">total_charger_power_kw</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">charger</span><span class="p">,</span> <span class="s1">&#39;max_charging_power&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="ow">or</span> <span class="mf">0.0</span> <span class="k">for</span> <span class="n">charger</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">electric_vehicle_chargers</span><span class="p">)</span>
        <span class="n">max_violation_energy</span> <span class="o">=</span> <span class="n">total_charger_power_kw</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seconds_per_time_step</span> <span class="o">/</span> <span class="mi">3600</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">observation_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;charging_phase_one_hot_&#39;</span><span class="p">):</span>
                <span class="n">low_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">high_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;charging_constraint_violation_kwh&#39;</span><span class="p">:</span>
                <span class="n">low_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">high_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_violation_energy</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;net_electricity_consumption&#39;</span><span class="p">:</span>
                <span class="c1"># assumes devices and storages have been sized</span>
                <span class="n">low_limits</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;non_shiftable_load&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">electrical_storage</span><span class="o">.</span><span class="n">nominal_power</span>
                    <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;solar_generation&#39;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">high_limits</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;non_shiftable_load&#39;</span><span class="p">]</span> \
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooling_device</span><span class="o">.</span><span class="n">nominal_power</span> \
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">nominal_power</span> \
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="o">.</span><span class="n">nominal_power</span> \
                                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">electrical_storage</span><span class="o">.</span><span class="n">nominal_power</span> \
                                    <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;solar_generation&#39;</span><span class="p">]</span>
                <span class="n">low_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">low_limits</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="mf">0.0</span><span class="p">)</span>
                <span class="n">high_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">high_limits</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;net_electricity_consumption_without_storage&#39;</span><span class="p">:</span>
                <span class="n">low_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">low_limit</span><span class="p">[</span><span class="s1">&#39;net_electricity_consumption&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">electrical_storage</span><span class="o">.</span><span class="n">nominal_power</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
                <span class="n">high_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">high_limit</span><span class="p">[</span><span class="s1">&#39;net_electricity_consumption&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">electrical_storage</span><span class="o">.</span><span class="n">nominal_power</span>

            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;net_electricity_consumption_without_storage_and_partial_load&#39;</span><span class="p">:</span>
                <span class="n">low_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">low_limit</span><span class="p">[</span><span class="s1">&#39;net_electricity_consumption_without_storage&#39;</span><span class="p">]</span>
                <span class="n">high_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">high_limit</span><span class="p">[</span><span class="s1">&#39;net_electricity_consumption_without_storage&#39;</span><span class="p">]</span>

            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;net_electricity_consumption_without_storage_and_partial_load_and_pv&#39;</span><span class="p">:</span>
                <span class="n">low_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">high_limits</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;non_shiftable_load&#39;</span><span class="p">]</span> \
                                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooling_device</span><span class="o">.</span><span class="n">nominal_power</span> \
                                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">nominal_power</span> \
                                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="o">.</span><span class="n">nominal_power</span>
                <span class="n">high_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">high_limits</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cooling_storage_soc&#39;</span><span class="p">,</span> <span class="s1">&#39;heating_storage_soc&#39;</span><span class="p">,</span> <span class="s1">&#39;dhw_storage_soc&#39;</span><span class="p">,</span>
                <span class="s1">&#39;electrical_storage_soc&#39;</span><span class="p">]:</span>
                <span class="n">low_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">high_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cooling_device_efficiency&#39;</span><span class="p">]:</span>
                <span class="n">cop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooling_device</span><span class="o">.</span><span class="n">get_cop</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;outdoor_dry_bulb_temperature&#39;</span><span class="p">],</span> <span class="n">heating</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">low_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">cop</span><span class="p">)</span>
                <span class="n">high_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">cop</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;heating_device_efficiency&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="p">,</span> <span class="n">HeatPump</span><span class="p">):</span>
                    <span class="n">cop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">get_cop</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;outdoor_dry_bulb_temperature&#39;</span><span class="p">],</span> <span class="n">heating</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">low_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">cop</span><span class="p">)</span>
                    <span class="n">high_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">cop</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">low_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">efficiency</span>
                    <span class="n">high_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">efficiency</span>

            <span class="k">elif</span> <span class="s1">&#39;connected_state&#39;</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">or</span> <span class="s2">&quot;_incoming_state&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                <span class="n">low_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">high_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="k">elif</span> <span class="s2">&quot;_departure_time&quot;</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">or</span> <span class="s2">&quot;_estimated_arrival_time&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                <span class="n">low_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">high_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">24</span>

            <span class="k">elif</span> <span class="s2">&quot;_soc&quot;</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">and</span> <span class="s2">&quot;_electric_vehicle&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                <span class="n">low_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1</span>
                <span class="n">high_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

            <span class="k">elif</span> <span class="s1">&#39;charger&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">electric_vehicle_chargers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">charger</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">electric_vehicle_chargers</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="sa">f</span><span class="s1">&#39;charger_</span><span class="si">{</span><span class="n">charger</span><span class="o">.</span><span class="n">charger_id</span><span class="si">}</span><span class="s1">_connected_state&#39;</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="sa">f</span><span class="s1">&#39;charger_</span><span class="si">{</span><span class="n">charger</span><span class="o">.</span><span class="n">charger_id</span><span class="si">}</span><span class="s1">_incoming_state&#39;</span><span class="p">:</span>
                            <span class="n">low_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">high_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="k">elif</span> <span class="s1">&#39;electric_vehicle_charger_state&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                            <span class="n">low_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">high_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">value</span> <span class="ow">in</span> <span class="n">key</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span>
                                 <span class="p">[</span><span class="s1">&#39;electric_vehicle_departure_time&#39;</span><span class="p">,</span> <span class="s1">&#39;electric_vehicle_estimated_arrival_time&#39;</span><span class="p">]):</span>
                            <span class="n">low_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                            <span class="n">high_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">24</span>
                        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">value</span> <span class="ow">in</span> <span class="n">key</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span>
                                 <span class="p">[</span><span class="s1">&#39;electric_vehicle_required_soc_departure&#39;</span><span class="p">,</span> <span class="s1">&#39;electric_vehicle_estimated_soc_arrival&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;electric_vehicle_soc&#39;</span><span class="p">]):</span>
                            <span class="n">low_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1</span>
                            <span class="n">high_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
                        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">value</span> <span class="ow">in</span> <span class="n">key</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;connected_electric_vehicle_at_charger_</span><span class="si">{</span><span class="n">charger</span><span class="o">.</span><span class="n">charger_id</span><span class="si">}</span><span class="s1">_battery_capacity&#39;</span><span class="p">]):</span>
                            <span class="n">low_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                            <span class="n">high_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span>

            <span class="k">elif</span> <span class="s1">&#39;washing_machine&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">washing_machines</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">washing_machine</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">washing_machines</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">washing_machine</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_start_time_step&#39;</span><span class="p">:</span>
                            <span class="n">low_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                            <span class="n">high_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">24</span>
                        <span class="k">elif</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">washing_machine</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_end_time_step&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                            <span class="n">low_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                            <span class="n">high_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">24</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;dhw_device_efficiency&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="p">,</span> <span class="n">HeatPump</span><span class="p">):</span>
                    <span class="n">cop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="o">.</span><span class="n">get_cop</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;outdoor_dry_bulb_temperature&#39;</span><span class="p">],</span> <span class="n">heating</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">low_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">cop</span><span class="p">)</span>
                    <span class="n">high_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">cop</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">low_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="o">.</span><span class="n">efficiency</span>
                    <span class="n">high_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="o">.</span><span class="n">efficiency</span>

            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;indoor_dry_bulb_temperature&#39;</span><span class="p">:</span>
                <span class="n">low_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;indoor_dry_bulb_temperature&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">maximum_temperature_delta</span>
                <span class="n">high_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;indoor_dry_bulb_temperature&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">maximum_temperature_delta</span>

            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;indoor_dry_bulb_temperature_cooling_delta&#39;</span><span class="p">,</span> <span class="s1">&#39;indoor_dry_bulb_temperature_heating_delta&#39;</span><span class="p">]:</span>
                <span class="n">low_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">maximum_temperature_delta</span>
                <span class="n">high_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maximum_temperature_delta</span>

            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;comfort_band&#39;</span><span class="p">:</span>
                <span class="n">low_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">high_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cooling_demand&#39;</span><span class="p">,</span> <span class="s1">&#39;heating_demand&#39;</span><span class="p">,</span> <span class="s1">&#39;dhw_demand&#39;</span><span class="p">]:</span>
                <span class="n">low_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">max_demand</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="n">high_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_demand</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">demand_observation_limit_factor</span>

            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;cooling_electricity_consumption&#39;</span><span class="p">:</span>
                <span class="n">low_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">high_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooling_device</span><span class="o">.</span><span class="n">nominal_power</span>

            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;heating_electricity_consumption&#39;</span><span class="p">:</span>
                <span class="n">low_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">high_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">nominal_power</span>

            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;dhw_electricity_consumption&#39;</span><span class="p">:</span>
                <span class="n">low_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">high_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="o">.</span><span class="n">nominal_power</span>

            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;cooling_storage_electricity_consumption&#39;</span><span class="p">:</span>
                <span class="n">demand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;cooling_demand&#39;</span><span class="p">,</span>
                    <span class="n">start_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_start_time_step</span><span class="p">,</span>
                    <span class="n">end_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_end_time_step</span>
                <span class="p">)</span>
                <span class="n">electricity_consumption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooling_device</span><span class="o">.</span><span class="n">get_input_power</span><span class="p">(</span><span class="n">demand</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;outdoor_dry_bulb_temperature&#39;</span><span class="p">],</span> <span class="kc">False</span><span class="p">)</span>
                <span class="n">low_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="nb">max</span><span class="p">(</span><span class="n">electricity_consumption</span><span class="p">)</span>
                <span class="n">high_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooling_device</span><span class="o">.</span><span class="n">nominal_power</span>

            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;heating_storage_electricity_consumption&#39;</span><span class="p">:</span>
                <span class="n">demand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;heating_demand&#39;</span><span class="p">,</span>
                    <span class="n">start_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_start_time_step</span><span class="p">,</span>
                    <span class="n">end_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_end_time_step</span>
                <span class="p">)</span>
                <span class="n">electricity_consumption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">get_input_power</span><span class="p">(</span><span class="n">demand</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;outdoor_dry_bulb_temperature&#39;</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span> \
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="p">,</span> <span class="n">HeatPump</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">get_input_power</span><span class="p">(</span><span class="n">demand</span><span class="p">)</span>
                <span class="n">low_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="nb">max</span><span class="p">(</span><span class="n">electricity_consumption</span><span class="p">)</span>
                <span class="n">high_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">nominal_power</span>

            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;dhw_storage_electricity_consumption&#39;</span><span class="p">:</span>
                <span class="n">demand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;dhw_demand&#39;</span><span class="p">,</span>
                    <span class="n">start_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_start_time_step</span><span class="p">,</span>
                    <span class="n">end_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_end_time_step</span>
                <span class="p">)</span>
                <span class="n">electricity_consumption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="o">.</span><span class="n">get_input_power</span><span class="p">(</span><span class="n">demand</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;outdoor_dry_bulb_temperature&#39;</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span> \
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="p">,</span> <span class="n">HeatPump</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="o">.</span><span class="n">get_input_power</span><span class="p">(</span><span class="n">demand</span><span class="p">)</span>
                <span class="n">low_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="nb">max</span><span class="p">(</span><span class="n">electricity_consumption</span><span class="p">)</span>
                <span class="n">high_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="o">.</span><span class="n">nominal_power</span>

            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;electrical_storage_electricity_consumption&#39;</span><span class="p">:</span>
                <span class="n">low_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">electrical_storage</span><span class="o">.</span><span class="n">nominal_power</span>
                <span class="n">high_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">electrical_storage</span><span class="o">.</span><span class="n">nominal_power</span>

            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;power_outage&#39;</span><span class="p">:</span>
                <span class="n">low_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">high_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

            <span class="k">elif</span> <span class="n">periodic_normalization</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">periodic_observations</span><span class="p">:</span>
                <span class="n">pn</span> <span class="o">=</span> <span class="n">PeriodicNormalization</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">periodic_observations</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
                <span class="n">x_sin</span><span class="p">,</span> <span class="n">x_cos</span> <span class="o">=</span> <span class="n">pn</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">periodic_observations</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
                <span class="n">low_limit</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">_cos&#39;</span><span class="p">],</span> <span class="n">high_limit</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">_cos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">x_cos</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">x_cos</span><span class="p">)</span>
                <span class="n">low_limit</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">_sin&#39;</span><span class="p">],</span> <span class="n">high_limit</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">_sin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">x_sin</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">x_sin</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;occupant_interaction_indoor_dry_bulb_temperature_set_point_delta&#39;</span><span class="p">:</span>
                <span class="c1"># will get set in the overriding  LogisticRegressionOccupantInteractionBuilding._get_observation_space_limits_data</span>
                <span class="k">pass</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">low_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                <span class="n">high_limit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

        <span class="n">low_limit</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation_space_limit_delta</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">low_limit</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">high_limit</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation_space_limit_delta</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">high_limit</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="k">return</span> <span class="n">low_limit</span><span class="p">,</span> <span class="n">high_limit</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_observation_space_limits_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]:</span>
        <span class="c1"># Use entire dataset length for space limit estimation</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span>
                <span class="n">k</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">),</span> 
                <span class="n">start_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_start_time_step</span><span class="p">,</span> 
                <span class="n">end_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_end_time_step</span>
            <span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="p">)},</span>
            <span class="s1">&#39;solar_generation&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pv</span><span class="o">.</span><span class="n">get_generation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span>
                <span class="s1">&#39;solar_generation&#39;</span><span class="p">,</span> 
                <span class="n">start_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_start_time_step</span><span class="p">,</span> 
                <span class="n">end_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_end_time_step</span>
            <span class="p">))),</span>
            <span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">weather</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span>
                <span class="n">k</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">),</span> 
                <span class="n">start_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_start_time_step</span><span class="p">,</span> 
                <span class="n">end_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_end_time_step</span>
            <span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weather</span><span class="p">)},</span>
            <span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">carbon_intensity</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span>
                <span class="n">k</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">),</span> 
                <span class="n">start_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_start_time_step</span><span class="p">,</span> 
                <span class="n">end_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_end_time_step</span>
            <span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">carbon_intensity</span><span class="p">)},</span>
            <span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">pricing</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span>
                <span class="n">k</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">),</span> 
                <span class="n">start_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_start_time_step</span><span class="p">,</span> 
                <span class="n">end_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_end_time_step</span>
            <span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pricing</span><span class="p">)},</span>
        <span class="p">}</span>

        <span class="n">timesteps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_time_steps</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_charging_constraints_enabled&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_expose_charging_constraints&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_building_charger_limit_kw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;charging_building_headroom_kw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">timesteps</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_building_charger_limit_kw</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase_limits</span><span class="p">:</span>
                    <span class="n">limit</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;limit_kw&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;charging_phase_</span><span class="si">{</span><span class="n">phase</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_headroom_kw&quot;</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">timesteps</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">limit</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>

            <span class="n">total_charger_power_kw</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">charger</span><span class="p">,</span> <span class="s1">&#39;max_charging_power&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="ow">or</span> <span class="mf">0.0</span> <span class="k">for</span> <span class="n">charger</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">electric_vehicle_chargers</span><span class="p">)</span>
            <span class="n">max_violation_energy</span> <span class="o">=</span> <span class="n">total_charger_power_kw</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seconds_per_time_step</span> <span class="o">/</span> <span class="mi">3600</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;charging_constraint_violation_kwh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">max_violation_energy</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>

            <span class="n">phase_one_hot_keys</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_phase_encoding_observation_keys&#39;</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">phase_one_hot_keys</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">phase_one_hot_keys</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>
    
<div class="viewcode-block" id="Building.estimate_action_space">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.Building.estimate_action_space">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">estimate_action_space</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">spaces</span><span class="o">.</span><span class="n">Box</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Get estimate of action spaces.</span>

<span class="sd">        Find minimum and maximum possible values of all the actions, which can then be used by the RL agent to scale the selected actions.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        action_space : spaces.Box</span>
<span class="sd">            Action low and high limits.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The lower and upper bounds for the `cooling_storage`, `heating_storage` and `dhw_storage` actions are set to (+/-) 1/maximum_demand for each respective end use, </span>
<span class="sd">        as the energy storage device can&#39;t provide the building with more energy than it will ever need for a given time step. . </span>
<span class="sd">        For example, if `cooling_storage` capacity is 20 kWh and the maximum `cooling_demand` is 5 kWh, its actions will be bounded between -5/20 and 5/20.</span>
<span class="sd">        These boundaries should speed up the learning process of the agents and make them more stable compared to setting them to -1 and 1. </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">low_limit</span><span class="p">,</span> <span class="n">high_limit</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_actions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;cooling_or_heating_device&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooling_device</span><span class="o">.</span><span class="n">nominal_power</span> <span class="o">&gt;</span> <span class="n">ZERO_DIVISION_PLACEHOLDER</span><span class="p">:</span>
                    <span class="n">low_limit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">low_limit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">nominal_power</span> <span class="o">&gt;</span> <span class="n">ZERO_DIVISION_PLACEHOLDER</span><span class="p">:</span>
                    <span class="n">high_limit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">high_limit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cooling_device&#39;</span><span class="p">,</span> <span class="s1">&#39;heating_device&#39;</span><span class="p">]:</span>
                <span class="n">low_limit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
                <span class="n">high_limit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

            <span class="k">elif</span> <span class="s1">&#39;electric_vehicle_storage&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">electric_vehicle_chargers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">electric_vehicle_chargers</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="sa">f</span><span class="s1">&#39;electric_vehicle_storage_</span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">charger_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span>
                            <span class="n">discharging_limit</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">max_discharging_power</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
                            <span class="n">high_limit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>  <span class="c1"># For discharging limit</span>
                            <span class="n">low_limit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">discharging_limit</span><span class="p">)</span>  <span class="c1"># For charging limit</span>
            
            <span class="k">elif</span> <span class="s1">&#39;washing_machine&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">washing_machines</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">wm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">washing_machines</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">wm</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span>
                            <span class="n">low_limit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
                            <span class="n">high_limit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>                

            <span class="k">elif</span> <span class="s1">&#39;storage&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;electrical_storage&#39;</span><span class="p">:</span>
                    <span class="n">limit</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;cooling_storage&#39;</span><span class="p">:</span>
                        <span class="n">capacity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooling_storage</span><span class="o">.</span><span class="n">capacity</span>
                        <span class="n">power</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooling_device</span><span class="o">.</span><span class="n">nominal_power</span>

                    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;heating_storage&#39;</span><span class="p">:</span>
                        <span class="n">capacity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_storage</span><span class="o">.</span><span class="n">capacity</span>
                        <span class="n">power</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">nominal_power</span>

                    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;dhw_storage&#39;</span><span class="p">:</span>
                        <span class="n">capacity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_storage</span><span class="o">.</span><span class="n">capacity</span>
                        <span class="n">power</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="o">.</span><span class="n">nominal_power</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unknown action: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                    <span class="n">limit</span> <span class="o">=</span> <span class="n">power</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="n">capacity</span><span class="p">,</span> <span class="n">ZERO_DIVISION_PLACEHOLDER</span><span class="p">)</span>

                <span class="n">limit</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
                <span class="n">low_limit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="n">limit</span><span class="p">)</span>
                <span class="n">high_limit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;cooling_storage&#39;</span><span class="p">:</span>
                    <span class="n">capacity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooling_storage</span><span class="o">.</span><span class="n">capacity</span>
                    <span class="n">cooling_demand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span>
                        <span class="s1">&#39;cooling_demand&#39;</span><span class="p">,</span>
                        <span class="n">start_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_start_time_step</span><span class="p">,</span>
                        <span class="n">end_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_end_time_step</span>
                    <span class="p">)</span>
                    <span class="n">maximum_demand</span> <span class="o">=</span> <span class="n">cooling_demand</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

                <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;heating_storage&#39;</span><span class="p">:</span>
                    <span class="n">capacity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_storage</span><span class="o">.</span><span class="n">capacity</span>
                    <span class="n">heating_demand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span>
                        <span class="s1">&#39;heating_demand&#39;</span><span class="p">,</span>
                        <span class="n">start_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_start_time_step</span><span class="p">,</span>
                        <span class="n">end_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_end_time_step</span>
                    <span class="p">)</span>
                    <span class="n">maximum_demand</span> <span class="o">=</span> <span class="n">heating_demand</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

                <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;dhw_storage&#39;</span><span class="p">:</span>
                    <span class="n">capacity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_storage</span><span class="o">.</span><span class="n">capacity</span>
                    <span class="n">dhw_demand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span>
                        <span class="s1">&#39;dhw_demand&#39;</span><span class="p">,</span>
                        <span class="n">start_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_start_time_step</span><span class="p">,</span>
                        <span class="n">end_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_end_time_step</span>
                    <span class="p">)</span>
                    <span class="n">maximum_demand</span> <span class="o">=</span> <span class="n">dhw_demand</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unknown action: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="n">maximum_demand_ratio</span> <span class="o">=</span> <span class="n">maximum_demand</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">capacity</span><span class="p">,</span> <span class="n">ZERO_DIVISION_PLACEHOLDER</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">low_limit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="o">-</span><span class="n">maximum_demand_ratio</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">))</span>
                    <span class="n">high_limit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">maximum_demand_ratio</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>

                <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
                    <span class="n">low_limit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
                    <span class="n">high_limit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">spaces</span><span class="o">.</span><span class="n">Box</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">low_limit</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">),</span> <span class="n">high</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">high_limit</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">),</span>
                          <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Building.autosize_cooling_device">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.Building.autosize_cooling_device">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">autosize_cooling_device</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Autosize `cooling_device` `nominal_power` to minimum power needed to always meet `cooling_demand`.</span>
<span class="sd">        </span>
<span class="sd">        Other Parameters</span>
<span class="sd">        ----------------</span>
<span class="sd">        **kwargs : dict</span>
<span class="sd">            Other keyword arguments parsed to `cooling_device` `autosize` function.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">demand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span>
            <span class="s1">&#39;cooling_demand&#39;</span><span class="p">,</span>
            <span class="n">start_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_start_time_step</span><span class="p">,</span>
            <span class="n">end_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_end_time_step</span>
        <span class="p">)</span>
        <span class="n">temperature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weather</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span>
            <span class="s1">&#39;outdoor_dry_bulb_temperature&#39;</span><span class="p">,</span>
            <span class="n">start_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_start_time_step</span><span class="p">,</span>
            <span class="n">end_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_end_time_step</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cooling_device</span><span class="o">.</span><span class="n">nominal_power</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooling_device</span><span class="o">.</span><span class="n">autosize</span><span class="p">(</span><span class="n">temperature</span><span class="p">,</span> <span class="n">cooling_demand</span><span class="o">=</span><span class="n">demand</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Building.autosize_heating_device">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.Building.autosize_heating_device">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">autosize_heating_device</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Autosize `heating_device` `nominal_power` to minimum power needed to always meet `heating_demand`.</span>
<span class="sd">        </span>
<span class="sd">        Other Parameters</span>
<span class="sd">        ----------------</span>
<span class="sd">        **kwargs : dict</span>
<span class="sd">            Other keyword arguments parsed to `heating_device` `autosize` function.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">demand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span>
            <span class="s1">&#39;heating_demand&#39;</span><span class="p">,</span>
            <span class="n">start_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_start_time_step</span><span class="p">,</span>
            <span class="n">end_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_end_time_step</span>
        <span class="p">)</span>
        <span class="n">temperature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weather</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span>
            <span class="s1">&#39;outdoor_dry_bulb_temperature&#39;</span><span class="p">,</span>
            <span class="n">start_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_start_time_step</span><span class="p">,</span>
            <span class="n">end_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_end_time_step</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="p">,</span> <span class="n">HeatPump</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">nominal_power</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">autosize</span><span class="p">(</span><span class="n">temperature</span><span class="p">,</span> <span class="n">heating_demand</span><span class="o">=</span><span class="n">demand</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">nominal_power</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">autosize</span><span class="p">(</span><span class="n">demand</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Building.autosize_dhw_device">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.Building.autosize_dhw_device">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">autosize_dhw_device</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Autosize `dhw_device` `nominal_power` to minimum power needed to always meet `dhw_demand`.</span>
<span class="sd">        </span>
<span class="sd">        Other Parameters</span>
<span class="sd">        ----------------</span>
<span class="sd">        **kwargs : dict</span>
<span class="sd">            Other keyword arguments parsed to `dhw_device` `autosize` function.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">demand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span>
            <span class="s1">&#39;dhw_demand&#39;</span><span class="p">,</span>
            <span class="n">start_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_start_time_step</span><span class="p">,</span>
            <span class="n">end_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_end_time_step</span>
        <span class="p">)</span>
        <span class="n">temperature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weather</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span>
            <span class="s1">&#39;outdoor_dry_bulb_temperature&#39;</span><span class="p">,</span>
            <span class="n">start_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_start_time_step</span><span class="p">,</span>
            <span class="n">end_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_end_time_step</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="p">,</span> <span class="n">HeatPump</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="o">.</span><span class="n">nominal_power</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="o">.</span><span class="n">autosize</span><span class="p">(</span><span class="n">temperature</span><span class="p">,</span> <span class="n">heating_demand</span><span class="o">=</span><span class="n">demand</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="o">.</span><span class="n">nominal_power</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="o">.</span><span class="n">autosize</span><span class="p">(</span><span class="n">demand</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Building.autosize_cooling_storage">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.Building.autosize_cooling_storage">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">autosize_cooling_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Autosize `cooling_storage` `capacity` to minimum capacity needed to always meet `cooling_demand`.</span>
<span class="sd">        </span>
<span class="sd">        Other Parameters</span>
<span class="sd">        ----------------</span>
<span class="sd">        **kwargs : dict</span>
<span class="sd">            Other keyword arguments parsed to `cooling_storage` `autosize` function.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">demand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span>
            <span class="s1">&#39;cooling_demand&#39;</span><span class="p">,</span>
            <span class="n">start_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_start_time_step</span><span class="p">,</span>
            <span class="n">end_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_end_time_step</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cooling_storage</span><span class="o">.</span><span class="n">capacity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooling_storage</span><span class="o">.</span><span class="n">autosize</span><span class="p">(</span><span class="n">demand</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Building.autosize_heating_storage">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.Building.autosize_heating_storage">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">autosize_heating_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Autosize `heating_storage` `capacity` to minimum capacity needed to always meet `heating_demand`.</span>
<span class="sd">        </span>
<span class="sd">        Other Parameters</span>
<span class="sd">        ----------------</span>
<span class="sd">        **kwargs : dict</span>
<span class="sd">            Other keyword arguments parsed to `heating_storage` `autosize` function.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">demand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span>
            <span class="s1">&#39;heating_demand&#39;</span><span class="p">,</span>
            <span class="n">start_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_start_time_step</span><span class="p">,</span>
            <span class="n">end_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_end_time_step</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heating_storage</span><span class="o">.</span><span class="n">capacity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_storage</span><span class="o">.</span><span class="n">autosize</span><span class="p">(</span><span class="n">demand</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Building.autosize_dhw_storage">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.Building.autosize_dhw_storage">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">autosize_dhw_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Autosize `dhw_storage` `capacity` to minimum capacity needed to always meet `dhw_demand`.</span>
<span class="sd">        </span>
<span class="sd">        Other Parameters</span>
<span class="sd">        ----------------</span>
<span class="sd">        **kwargs : dict</span>
<span class="sd">            Other keyword arguments parsed to `dhw_storage` `autosize` function.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">demand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span>
            <span class="s1">&#39;dhw_demand&#39;</span><span class="p">,</span>
            <span class="n">start_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_start_time_step</span><span class="p">,</span>
            <span class="n">end_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_end_time_step</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dhw_storage</span><span class="o">.</span><span class="n">capacity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_storage</span><span class="o">.</span><span class="n">autosize</span><span class="p">(</span><span class="n">demand</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Building.autosize_electrical_storage">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.Building.autosize_electrical_storage">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">autosize_electrical_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Autosize `electrical_storage` `capacity`, `nominal_power`, `depth_of_discharge`, `efficiency`, </span>
<span class="sd">        `loss_coefficient`, and `capacity_loss_coefficient` to meet an estimated average peak demand.</span>
<span class="sd">        </span>
<span class="sd">        Other Parameters</span>
<span class="sd">        ----------------</span>
<span class="sd">        **kwargs : dict</span>
<span class="sd">            Other keyword arguments parsed to `electrical_storage` `autosize` function.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">demand</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_estimate_baseline_electricity_consumption</span><span class="p">(),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
        <span class="n">demand</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">demand</span><span class="o">.</span><span class="n">index</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seconds_per_time_step</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">seconds_per_time_step</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">demand</span> <span class="o">=</span> <span class="n">demand</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;day&#39;</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">electrical_storage</span><span class="o">.</span><span class="n">capacity</span><span class="p">,</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">electrical_storage</span><span class="o">.</span><span class="n">nominal_power</span><span class="p">,</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">electrical_storage</span><span class="o">.</span><span class="n">depth_of_discharge</span><span class="p">,</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">electrical_storage</span><span class="o">.</span><span class="n">efficiency</span><span class="p">,</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">electrical_storage</span><span class="o">.</span><span class="n">loss_coefficient</span><span class="p">,</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">electrical_storage</span><span class="o">.</span><span class="n">capacity_loss_coefficient</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">electrical_storage</span><span class="o">.</span><span class="n">autosize</span><span class="p">(</span><span class="n">demand</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Building.autosize_pv">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.Building.autosize_pv">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">autosize_pv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Autosize `pv` `nominal_power` and set `energy_simulation.solar_generation` using sampled PV data from</span>
<span class="sd">        LBNL&#39;s Tracking The Sun dataset.</span>
<span class="sd">        </span>
<span class="sd">        Other Parameters</span>
<span class="sd">        ----------------</span>
<span class="sd">        **kwargs : dict</span>
<span class="sd">            Other keyword arguments parsed to `electrical_storage` `autosize` function.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">demand</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_estimate_baseline_electricity_consumption</span><span class="p">(),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
        <span class="n">demand</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">demand</span><span class="o">.</span><span class="n">index</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seconds_per_time_step</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">365</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">seconds_per_time_step</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">demand</span> <span class="o">=</span> <span class="n">demand</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">epw_filepath</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;epw_filepath&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pv</span><span class="o">.</span><span class="n">nominal_power</span><span class="p">,</span> <span class="n">solar_generation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pv</span><span class="o">.</span><span class="n">autosize</span><span class="p">(</span><span class="n">demand</span><span class="p">,</span> <span class="n">epw_filepath</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="s1">&#39;solar_generation&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">solar_generation</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">))</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_estimate_baseline_electricity_consumption</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns estimated baseline electricity consumption time series for entire simulation period.</span>
<span class="sd">        </span>
<span class="sd">        The estimate is the sum of estimated cooling, heating, domestic hot water and non-shiftable </span>
<span class="sd">        load consumption without storage and self-generation flexibility.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        baseline_electricity_consumption: np.ndarray</span>
<span class="sd">            Estimate time series for simulation period which may be equal to or longer than the current</span>
<span class="sd">            episode&#39;s number of time steps.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">cooling_demand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span>
            <span class="s1">&#39;cooling_demand&#39;</span><span class="p">,</span>
            <span class="n">start_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_start_time_step</span><span class="p">,</span>
            <span class="n">end_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_end_time_step</span>
        <span class="p">)</span>
        <span class="n">heating_demand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span>
            <span class="s1">&#39;heating_demand&#39;</span><span class="p">,</span>
            <span class="n">start_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_start_time_step</span><span class="p">,</span>
            <span class="n">end_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_end_time_step</span>
        <span class="p">)</span>
        <span class="n">dhw_demand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span>
            <span class="s1">&#39;dhw_demand&#39;</span><span class="p">,</span>
            <span class="n">start_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_start_time_step</span><span class="p">,</span>
            <span class="n">end_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_end_time_step</span>
        <span class="p">)</span>
        <span class="n">non_shiftable_electricity_consumption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span>
            <span class="s1">&#39;non_shiftable_load&#39;</span><span class="p">,</span>
            <span class="n">start_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_start_time_step</span><span class="p">,</span>
            <span class="n">end_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_end_time_step</span>
        <span class="p">)</span>
        <span class="n">outdoor_dry_bulb_temperature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weather</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span>
            <span class="s1">&#39;outdoor_dry_bulb_temperature&#39;</span><span class="p">,</span>
            <span class="n">start_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_start_time_step</span><span class="p">,</span>
            <span class="n">end_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_end_time_step</span>
        <span class="p">)</span>
        <span class="n">cooling_electricity_consumption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooling_device</span><span class="o">.</span><span class="n">get_input_power</span><span class="p">(</span><span class="n">cooling_demand</span><span class="p">,</span> <span class="n">outdoor_dry_bulb_temperature</span><span class="p">,</span> <span class="n">heating</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="p">,</span> <span class="n">HeatPump</span><span class="p">):</span>
            <span class="n">heating_electricity_consumption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">get_input_power</span><span class="p">(</span><span class="n">heating_demand</span><span class="p">,</span> <span class="n">outdoor_dry_bulb_temperature</span><span class="p">,</span> <span class="n">heating</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">heating_electricity_consumption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">get_input_power</span><span class="p">(</span><span class="n">heating_demand</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="p">,</span> <span class="n">HeatPump</span><span class="p">):</span>
            <span class="n">dhw_electricity_consumption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="o">.</span><span class="n">get_input_power</span><span class="p">(</span><span class="n">dhw_demand</span><span class="p">,</span> <span class="n">outdoor_dry_bulb_temperature</span><span class="p">,</span> <span class="n">heating</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">dhw_electricity_consumption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="o">.</span><span class="n">get_input_power</span><span class="p">(</span><span class="n">dhw_demand</span><span class="p">)</span>

        <span class="n">electricity_consumption</span> <span class="o">=</span> <span class="n">cooling_electricity_consumption</span> \
            <span class="o">+</span> <span class="n">heating_electricity_consumption</span> \
                <span class="o">+</span> <span class="n">dhw_electricity_consumption</span> \
                    <span class="o">+</span> <span class="n">non_shiftable_electricity_consumption</span>

        <span class="k">return</span> <span class="n">electricity_consumption</span>

<div class="viewcode-block" id="Building.next_time_step">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.Building.next_time_step">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">next_time_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Advance all energy storage and electric devices and, PV to next `time_step`.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cooling_device</span><span class="o">.</span><span class="n">next_time_step</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">next_time_step</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="o">.</span><span class="n">next_time_step</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">non_shiftable_load_device</span><span class="o">.</span><span class="n">next_time_step</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cooling_storage</span><span class="o">.</span><span class="n">next_time_step</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heating_storage</span><span class="o">.</span><span class="n">next_time_step</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dhw_storage</span><span class="o">.</span><span class="n">next_time_step</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">electrical_storage</span><span class="o">.</span><span class="n">next_time_step</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pv</span><span class="o">.</span><span class="n">next_time_step</span><span class="p">()</span>


        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">electric_vehicle_chargers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">electric_vehicle_chargers</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">next_time_step</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">washing_machines</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">washing_machines</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">wm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">washing_machines</span><span class="p">:</span>
                <span class="n">wm</span><span class="o">.</span><span class="n">next_time_step</span><span class="p">()</span>        

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">next_time_step</span><span class="p">()</span></div>


<div class="viewcode-block" id="Building.reset">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.Building.reset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Reset `Building` to initial state.&quot;&quot;&quot;</span>

        <span class="c1"># object reset</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cooling_storage</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heating_storage</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dhw_storage</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">electrical_storage</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cooling_device</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">non_shiftable_load_device</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pv</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">electric_vehicle_chargers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">electric_vehicle_chargers</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">washing_machines</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">washing_machines</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">wm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">washing_machines</span><span class="p">:</span>
                <span class="n">wm</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>      

        <span class="c1"># variable reset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_dynamic_variables</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_data_sets</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__solar_generation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pv</span><span class="o">.</span><span class="n">get_generation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">solar_generation</span><span class="p">)</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__energy_from_cooling_device</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">cooling_demand</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__energy_from_heating_device</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">heating_demand</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__energy_from_dhw_device</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">dhw_demand</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__energy_to_non_shiftable_load</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">non_shiftable_load</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__net_electricity_consumption</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">episode_time_steps</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__net_electricity_consumption_emission</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">episode_time_steps</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__net_electricity_consumption_cost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">episode_time_steps</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__power_outage_signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_power_outage_signal</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__chargers_electricity_consumption</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">episode_time_steps</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__washing_machines_electricity_consumption</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">episode_time_steps</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Building.reset_power_outage_signal">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.Building.reset_power_outage_signal">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reset_power_outage_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resets power outage signal time series.</span>
<span class="sd">        </span>
<span class="sd">        Resets to zeros if `simulate_power_outage` is `False` otherwise, resets to a stochastic time series </span>
<span class="sd">        if `stochastic_power_outage` is `True` or the  time series defined in `energy_simulation.power_outage`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        power_outage_signal: np.ndarray</span>
<span class="sd">            Power outage signal time series.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">power_outage_signal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">episode_time_steps</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_power_outage</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stochastic_power_outage</span><span class="p">:</span>
                <span class="n">power_outage_signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stochastic_power_outage_model</span><span class="o">.</span><span class="n">get_signals</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">episode_time_steps</span><span class="p">,</span>
                    <span class="n">seconds_per_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seconds_per_time_step</span><span class="p">,</span>
                    <span class="n">weather</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">weather</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">power_outage_signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">power_outage</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">return</span> <span class="n">power_outage_signal</span></div>


<div class="viewcode-block" id="Building.reset_dynamic_variables">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.Building.reset_dynamic_variables">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reset_dynamic_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resets data file variables that change during control to their initial values.&quot;&quot;&quot;</span>

        <span class="k">pass</span></div>


<div class="viewcode-block" id="Building.reset_data_sets">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.Building.reset_data_sets">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reset_data_sets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resets time series data `start_time_step` and `end_time_step` with respect to current episode&#39;s time step settings.&quot;&quot;&quot;</span>

        <span class="n">start_time_step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">episode_start_time_step</span>
        <span class="n">end_time_step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">episode_end_time_step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">start_time_step</span> <span class="o">=</span> <span class="n">start_time_step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weather</span><span class="o">.</span><span class="n">start_time_step</span> <span class="o">=</span> <span class="n">start_time_step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pricing</span><span class="o">.</span><span class="n">start_time_step</span> <span class="o">=</span> <span class="n">start_time_step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">carbon_intensity</span><span class="o">.</span><span class="n">start_time_step</span> <span class="o">=</span> <span class="n">start_time_step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">end_time_step</span> <span class="o">=</span> <span class="n">end_time_step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weather</span><span class="o">.</span><span class="n">end_time_step</span> <span class="o">=</span> <span class="n">end_time_step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pricing</span><span class="o">.</span><span class="n">end_time_step</span> <span class="o">=</span> <span class="n">end_time_step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">carbon_intensity</span><span class="o">.</span><span class="n">end_time_step</span> <span class="o">=</span> <span class="n">end_time_step</span></div>


<div class="viewcode-block" id="Building.update_variables">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.Building.update_variables">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update cooling, heating, dhw and net electricity consumption as well as net electricity consumption cost and carbon emissions.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">temperature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weather</span><span class="o">.</span><span class="n">outdoor_dry_bulb_temperature</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span>

            <span class="c1"># cooling electricity consumption</span>
            <span class="n">cooling_demand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__energy_from_cooling_device</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooling_storage</span><span class="o">.</span><span class="n">energy_balance</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span>
            <span class="n">cooling_electricity_consumption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooling_device</span><span class="o">.</span><span class="n">get_input_power</span><span class="p">(</span><span class="n">cooling_demand</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">heating</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cooling_device</span><span class="o">.</span><span class="n">update_electricity_consumption</span><span class="p">(</span><span class="n">cooling_electricity_consumption</span><span class="p">)</span>

            <span class="c1"># heating electricity consumption</span>
            <span class="n">heating_demand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__energy_from_heating_device</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_storage</span><span class="o">.</span><span class="n">energy_balance</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="p">,</span> <span class="n">HeatPump</span><span class="p">):</span>
                <span class="n">heating_electricity_consumption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">get_input_power</span><span class="p">(</span><span class="n">heating_demand</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">heating</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">heating_electricity_consumption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="o">.</span><span class="n">get_input_power</span><span class="p">(</span><span class="n">heating_demand</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">update_electricity_consumption</span><span class="p">(</span><span class="n">heating_electricity_consumption</span><span class="p">)</span>

            <span class="c1"># dhw electricity consumption</span>
            <span class="n">dhw_demand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__energy_from_dhw_device</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_storage</span><span class="o">.</span><span class="n">energy_balance</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="p">,</span> <span class="n">HeatPump</span><span class="p">):</span>
                <span class="n">dhw_electricity_consumption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="o">.</span><span class="n">get_input_power</span><span class="p">(</span><span class="n">dhw_demand</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">heating</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dhw_electricity_consumption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="o">.</span><span class="n">get_input_power</span><span class="p">(</span><span class="n">dhw_demand</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="o">.</span><span class="n">update_electricity_consumption</span><span class="p">(</span><span class="n">dhw_electricity_consumption</span><span class="p">)</span>

            <span class="c1"># non shiftable load electricity consumption</span>
            <span class="n">non_shiftable_load_electricity_consumption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__energy_to_non_shiftable_load</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">non_shiftable_load_device</span><span class="o">.</span><span class="n">update_electricity_consumption</span><span class="p">(</span><span class="n">non_shiftable_load_electricity_consumption</span><span class="p">)</span>

            <span class="c1"># electrical storage</span>
            <span class="n">electrical_storage_electricity_consumption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">electrical_storage</span><span class="o">.</span><span class="n">energy_balance</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">electrical_storage</span><span class="o">.</span><span class="n">update_electricity_consumption</span><span class="p">(</span><span class="n">electrical_storage_electricity_consumption</span><span class="p">,</span> <span class="n">enforce_polarity</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">building_chargers_total_electricity_consumption</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">electric_vehicle_chargers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">electric_vehicle_chargers</span><span class="p">:</span>
                <span class="c1"># include charger electricity consumption for current timestep</span>
                <span class="n">building_chargers_total_electricity_consumption</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">building_chargers_total_electricity_consumption</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">electricity_consumption</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__chargers_electricity_consumption</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span> <span class="o">=</span> <span class="n">building_chargers_total_electricity_consumption</span>

        <span class="n">building_washing_machines_total_electricity_consumption</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">washing_machines</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">washing_machines</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">wm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">washing_machines</span><span class="p">:</span>
                <span class="n">building_washing_machines_total_electricity_consumption</span> <span class="o">=</span> \
                    <span class="n">building_washing_machines_total_electricity_consumption</span> <span class="o">+</span> <span class="n">wm</span><span class="o">.</span><span class="n">electricity_consumption</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__washing_machines_electricity_consumption</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span> <span class="o">=</span> <span class="n">building_washing_machines_total_electricity_consumption</span>

        <span class="c1"># net electricity consumption</span>
        <span class="n">net_electricity_consumption</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_outage</span><span class="p">:</span>
            <span class="n">net_electricity_consumption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooling_device</span><span class="o">.</span><span class="n">electricity_consumption</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span> \
                                          <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">electricity_consumption</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span> \
                                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="o">.</span><span class="n">electricity_consumption</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span> \
                                                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_shiftable_load_device</span><span class="o">.</span><span class="n">electricity_consumption</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span> \
                                                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">electrical_storage</span><span class="o">.</span><span class="n">electricity_consumption</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span> \
                                                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">solar_generation</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span> \
                                                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__chargers_electricity_consumption</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span> \
                                                                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__washing_machines_electricity_consumption</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__net_electricity_consumption</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span> <span class="o">=</span> <span class="n">net_electricity_consumption</span>

        <span class="c1"># net electriciy consumption cost</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__net_electricity_consumption_cost</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span> <span class="o">=</span> <span class="n">net_electricity_consumption</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pricing</span><span class="o">.</span><span class="n">electricity_pricing</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span>

        <span class="c1"># net electriciy consumption emission</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__net_electricity_consumption_emission</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">net_electricity_consumption</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">carbon_intensity</span><span class="o">.</span><span class="n">carbon_intensity</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">])</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a text representation of the current state.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">as_dict</span><span class="p">())</span>

<div class="viewcode-block" id="Building.as_dict">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.Building.as_dict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a dictionary representation of the current state for use in rendering or logging.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;Net Electricity Consumption-kWh&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">net_electricity_consumption</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Non-shiftable Load-kWh&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">non_shiftable_load</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Non-shiftable Load Electricity Consumption-kWh&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">non_shiftable_load_electricity_consumption</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Energy Production from PV-kWh&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">solar_generation</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="Building.render_simulation_end_data">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.Building.render_simulation_end_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">render_simulation_end_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a dictionary containing all simulation data across all time steps.</span>
<span class="sd">        The returned dictionary is structured with the building name and, for each time step,</span>
<span class="sd">        a dictionary with the simulation data, including energy, weather, storage, and device information.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        result : dict</span>
<span class="sd">            A JSON-like dictionary with the building name and per-time-step data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;episode_tracker&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Episode tracker is not initialized.&quot;</span><span class="p">)</span>

        <span class="n">num_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">episode_time_steps</span>  <span class="c1"># Total number of time steps in the simulation</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;simulation_data&#39;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_steps</span><span class="p">):</span>
            <span class="n">time_step_data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;time_step&#39;</span><span class="p">:</span> <span class="n">t</span><span class="p">,</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s1">&#39;energy_simulation&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;cooling_demand&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">cooling_demand</span><span class="p">[</span><span class="n">t</span><span class="p">],</span>
                    <span class="s1">&#39;heating_demand&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">heating_demand</span><span class="p">[</span><span class="n">t</span><span class="p">],</span>
                    <span class="s1">&#39;dhw_demand&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">dhw_demand</span><span class="p">[</span><span class="n">t</span><span class="p">],</span>
                    <span class="s1">&#39;solar_generation&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">solar_generation</span><span class="p">[</span><span class="n">t</span><span class="p">],</span>
                    <span class="s1">&#39;indoor_temperature&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">indoor_dry_bulb_temperature</span><span class="p">[</span><span class="n">t</span><span class="p">],</span>
                    <span class="s1">&#39;solar_generation&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">solar_generation</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
                <span class="p">},</span>
                <span class="s1">&#39;weather&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;outdoor_temperature&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">weather</span><span class="o">.</span><span class="n">outdoor_dry_bulb_temperature</span><span class="p">[</span><span class="n">t</span><span class="p">],</span>
                    <span class="s1">&#39;direct_solar_irradiance&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">weather</span><span class="o">.</span><span class="n">direct_solar_irradiance</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
                <span class="p">},</span>
                <span class="s1">&#39;carbon_intensity&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">carbon_intensity</span><span class="o">.</span><span class="n">carbon_intensity</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">carbon_intensity</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;pricing&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;electricity_price&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pricing</span><span class="o">.</span><span class="n">electricity_pricing</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pricing</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="s1">&#39;storage&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;dhw_storage&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;soc&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_storage</span><span class="o">.</span><span class="n">soc</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_storage</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s1">&#39;capacity&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_storage</span><span class="o">.</span><span class="n">capacity</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_storage</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;cooling_storage&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;soc&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooling_storage</span><span class="o">.</span><span class="n">soc</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooling_storage</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s1">&#39;capacity&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooling_storage</span><span class="o">.</span><span class="n">capacity</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooling_storage</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;heating_storage&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;soc&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_storage</span><span class="o">.</span><span class="n">soc</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_storage</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s1">&#39;capacity&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_storage</span><span class="o">.</span><span class="n">capacity</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_storage</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;electrical_storage&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;soc&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">electrical_storage</span><span class="o">.</span><span class="n">soc</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">electrical_storage</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s1">&#39;capacity&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">electrical_storage</span><span class="o">.</span><span class="n">capacity</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">electrical_storage</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="s1">&#39;devices&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;dhw_device&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;electricity_consumption&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="o">.</span><span class="n">electricity_consumption</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s1">&#39;nominal_power&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="o">.</span><span class="n">nominal_power</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;cooling_device&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;electricity_consumption&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooling_device</span><span class="o">.</span><span class="n">electricity_consumption</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooling_device</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s1">&#39;nominal_power&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooling_device</span><span class="o">.</span><span class="n">nominal_power</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooling_device</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;heating_device&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;electricity_consumption&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">electricity_consumption</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s1">&#39;nominal_power&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">nominal_power</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="s1">&#39;pv&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;power_generation&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pv</span><span class="o">.</span><span class="n">electricity_consumption</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pv</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;nominal_power&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pv</span><span class="o">.</span><span class="n">nominal_power</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pv</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="p">},</span>
                <span class="s1">&#39;observations&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">observations</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;observations&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="p">}</span>

            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;simulation_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time_step_data</span><span class="p">)</span></div>
</div>


<div class="viewcode-block" id="DynamicsBuilding">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.DynamicsBuilding">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DynamicsBuilding</span><span class="p">(</span><span class="n">Building</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Base class for temperature dynamic building.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    *args: Any</span>
<span class="sd">        Positional arguments in :py:class:`citylearn.building.Building`.</span>
<span class="sd">    dynamics: Dynamics</span>
<span class="sd">        Indoor dry-bulb temperature dynamics model.</span>
<span class="sd">    ignore_dynamics: bool, default: False</span>
<span class="sd">        Wether to simulate temperature dynamics at any time step.</span>

<span class="sd">    Other Parameters</span>
<span class="sd">    ----------------</span>
<span class="sd">    **kwargs : Any</span>
<span class="sd">        Other keyword arguments used to initialize :py:class:`citylearn.building.Building` super class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">dynamics</span><span class="p">:</span> <span class="n">Dynamics</span><span class="p">,</span> <span class="n">ignore_dynamics</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Intialize `DynamicsBuilding`&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span> <span class="o">=</span> <span class="n">dynamics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_dynamics</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">ignore_dynamics</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ignore_dynamics</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">simulate_dynamics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Whether to predict indoor dry-bulb temperature at current `time_step`.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_dynamics</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">net_electricity_consumption_emission_without_storage_and_partial_load_and_pv</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Carbon dioxide emmission from `net_electricity_consumption_without_storage_and_partial_load_pv` time series, in [kg_co2].&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">carbon_intensity</span><span class="o">.</span><span class="n">carbon_intensity</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">*</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">net_electricity_consumption_without_storage_and_partial_load_and_pv</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">net_electricity_consumption_cost_without_storage_and_partial_load_and_pv</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;net_electricity_consumption_without_storage_and_partial_load_and_pv` cost time series, in [$].&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pricing</span><span class="o">.</span><span class="n">electricity_pricing</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">net_electricity_consumption_without_storage_and_partial_load_and_pv</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">net_electricity_consumption_without_storage_and_partial_load_and_pv</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Net electricity consumption in the absence of flexibility provided by storage devices, </span>
<span class="sd">        partial load cooling and heating devices and self generation time series, in [kWh]. </span>
<span class="sd">        </span>
<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        net_electricity_consumption_without_storage_and_partial_load_and_pv = </span>
<span class="sd">        `net_electricity_consumption_without_storage_and_partial_load` - `solar_generation`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">net_electricity_consumption_without_storage_and_partial_load</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">solar_generation</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">net_electricity_consumption_emission_without_storage_and_partial_load</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Carbon dioxide emmission from `net_electricity_consumption_without_storage_and_partial_load` time series, in [kg_co2].&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">carbon_intensity</span><span class="o">.</span><span class="n">carbon_intensity</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>\
                <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">net_electricity_consumption_without_storage_and_partial_load</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">net_electricity_consumption_cost_without_storage_and_partial_load</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;`net_electricity_consumption_without_storage_and_partial_load` cost time series, in [$].&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pricing</span><span class="o">.</span><span class="n">electricity_pricing</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">net_electricity_consumption_without_storage_and_partial_load</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">net_electricity_consumption_without_storage_and_partial_load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Net electricity consumption in the absence of flexibility provided by </span>
<span class="sd">        storage devices and partial load cooling and heating devices time series, in [kWh].&quot;&quot;&quot;</span>

        <span class="c1"># cooling electricity consumption</span>
        <span class="n">cooling_demand_difference</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooling_demand_without_partial_load</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooling_demand</span>
        <span class="n">cooling_electricity_consumption_difference</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooling_device</span><span class="o">.</span><span class="n">get_input_power</span><span class="p">(</span>
            <span class="n">cooling_demand_difference</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weather</span><span class="o">.</span><span class="n">outdoor_dry_bulb_temperature</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">heating</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="c1"># heating electricity consumption</span>
        <span class="n">heating_demand_difference</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_demand_without_partial_load</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_demand</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="p">,</span> <span class="n">HeatPump</span><span class="p">):</span>
            <span class="n">heating_electricity_consumption_difference</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">get_input_power</span><span class="p">(</span>
                <span class="n">heating_demand_difference</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">weather</span><span class="o">.</span><span class="n">outdoor_dry_bulb_temperature</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">],</span>
                <span class="n">heating</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">heating_electricity_consumption_difference</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dhw_device</span><span class="o">.</span><span class="n">get_input_power</span><span class="p">(</span><span class="n">heating_demand_difference</span><span class="p">)</span>

        <span class="c1"># net electricity consumption without storage and partial load</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">net_electricity_consumption_without_storage</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span>
            <span class="n">cooling_electricity_consumption_difference</span><span class="p">,</span>
            <span class="n">heating_electricity_consumption_difference</span><span class="p">,</span>
        <span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">heating_demand_without_partial_load</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Total building space ideal heating demand time series in [kWh].</span>
<span class="sd">        </span>
<span class="sd">        This is the demand when heating_device is not controlled and always supplies ideal load.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">heating_demand_without_control</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cooling_demand_without_partial_load</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Total building space ideal cooling demand time series in [kWh].</span>
<span class="sd">        </span>
<span class="sd">        This is the demand when cooling_device is not controlled and always supplies ideal load.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">cooling_demand_without_control</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">indoor_dry_bulb_temperature_without_partial_load</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ideal load dry bulb temperature time series in [C].</span>
<span class="sd">        </span>
<span class="sd">        This is the temperature when cooling_device and heating_device</span>
<span class="sd">        are not controlled and always supply ideal load.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">indoor_dry_bulb_temperature_without_control</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

<div class="viewcode-block" id="DynamicsBuilding.apply_actions">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.DynamicsBuilding.apply_actions">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">apply_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">apply_actions</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_dynamics_input</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_dynamics</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_indoor_dry_bulb_temperature</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span></div>


<div class="viewcode-block" id="DynamicsBuilding.update_indoor_dry_bulb_temperature">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.DynamicsBuilding.update_indoor_dry_bulb_temperature">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_indoor_dry_bulb_temperature</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


<div class="viewcode-block" id="DynamicsBuilding.get_dynamics_input">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.DynamicsBuilding.get_dynamics_input">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_dynamics_input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_update_dynamics_input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

<div class="viewcode-block" id="DynamicsBuilding.reset_dynamic_variables">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.DynamicsBuilding.reset_dynamic_variables">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reset_dynamic_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resets data file variables that change during control to their initial values.</span>
<span class="sd">        </span>
<span class="sd">        Resets cooling demand, heating deamand and indoor temperature time series to their initial value </span>
<span class="sd">        at the beginning of an episode.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">start_ix</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">end_ix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">episode_time_steps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">cooling_demand</span><span class="p">[</span>
        <span class="n">start_ix</span><span class="p">:</span><span class="n">end_ix</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">cooling_demand_without_control</span><span class="o">.</span><span class="n">copy</span><span class="p">()[</span><span class="n">start_ix</span><span class="p">:</span><span class="n">end_ix</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">heating_demand</span><span class="p">[</span>
        <span class="n">start_ix</span><span class="p">:</span><span class="n">end_ix</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">heating_demand_without_control</span><span class="o">.</span><span class="n">copy</span><span class="p">()[</span><span class="n">start_ix</span><span class="p">:</span><span class="n">end_ix</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">indoor_dry_bulb_temperature</span><span class="p">[</span>
        <span class="n">start_ix</span><span class="p">:</span><span class="n">end_ix</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">indoor_dry_bulb_temperature_without_control</span><span class="o">.</span><span class="n">copy</span><span class="p">()[</span><span class="n">start_ix</span><span class="p">:</span><span class="n">end_ix</span><span class="p">]</span></div>


<div class="viewcode-block" id="DynamicsBuilding.reset">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.DynamicsBuilding.reset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset Building to initial state and resets `dynamics`.&quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="LSTMDynamicsBuilding">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.LSTMDynamicsBuilding">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">LSTMDynamicsBuilding</span><span class="p">(</span><span class="n">DynamicsBuilding</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Class for building with LSTM temperature dynamics model.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    *args: Any</span>
<span class="sd">        Positional arguments in :py:class:`citylearn.building.Building`.</span>
<span class="sd">    dynamics: Dynamics</span>
<span class="sd">        Indoor dry-bulb temperature dynamics model.</span>

<span class="sd">    Other Parameters</span>
<span class="sd">    ----------------</span>
<span class="sd">    **kwargs : Any</span>
<span class="sd">        Other keyword arguments used to initialize :py:class:`citylearn.building.Building` super class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">dynamics</span><span class="p">:</span> <span class="n">LSTMDynamics</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">dynamics</span><span class="o">=</span><span class="n">dynamics</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span><span class="p">:</span> <span class="n">LSTMDynamics</span>

    <span class="nd">@DynamicsBuilding</span><span class="o">.</span><span class="n">simulate_dynamics</span><span class="o">.</span><span class="n">getter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">simulate_dynamics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">simulate_dynamics</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span><span class="o">.</span><span class="n">_model_input</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

<div class="viewcode-block" id="LSTMDynamicsBuilding.update_indoor_dry_bulb_temperature">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.LSTMDynamicsBuilding.update_indoor_dry_bulb_temperature">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_indoor_dry_bulb_temperature</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Predict and update indoor dry-bulb temperature for current `time_step`.</span>

<span class="sd">        This method will first apply min-max normalization to the model input data where the input data</span>
<span class="sd">        is made up of building and district level observations including the predicted </span>
<span class="sd">        :py:attr:`citylearn.building.Building.energy_simulation.indoor_dry_bulb_temperature` </span>
<span class="sd">        with all input variables having a length of :py:attr:`citylearn.dynamics.LSTMDynamics.lookback`.</span>
<span class="sd">        asides the `indoor_dry_bulb_temperature` whose input includes all values from</span>
<span class="sd">        `time_step` - (`lookback` + 1) to `time_step` - 1, other input variables have values from</span>
<span class="sd">        `time_step` - `lookback` to `time_step`. The `indoor_dry_bulb_temperature` for the current `time_step`</span>
<span class="sd">        is then predicted using the input data and current `hidden_state` and the predicted values replaces the</span>
<span class="sd">        current `time_step` value in :py:attr:`citylearn.building.Building.energy_simulation.indoor_dry_bulb_temperature`.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        LSTM model only uses either cooling/heating demand not both as input variable. </span>
<span class="sd">        Use :py:attr:`citylearn.building.Building.energy_simulation.hvac_mode` to specify whether to consider cooling </span>
<span class="sd">        or heating demand at each `time_step`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># predict</span>
        <span class="n">model_input_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_dynamics_input</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">model_input_tensor</span> <span class="o">=</span> <span class="n">model_input_tensor</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="n">hidden_state</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">h</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span><span class="o">.</span><span class="n">_hidden_state</span><span class="p">])</span>
        <span class="n">indoor_dry_bulb_temperature_norm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span><span class="o">.</span><span class="n">_hidden_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span><span class="p">(</span><span class="n">model_input_tensor</span><span class="o">.</span><span class="n">float</span><span class="p">(),</span> <span class="n">hidden_state</span><span class="p">)</span>

        <span class="c1"># update dry bulb temperature for current time step in model input</span>
        <span class="n">ix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span><span class="o">.</span><span class="n">input_observation_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;indoor_dry_bulb_temperature&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span><span class="o">.</span><span class="n">_model_input</span><span class="p">[</span><span class="n">ix</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">indoor_dry_bulb_temperature_norm</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

        <span class="c1"># unnormalize temperature</span>
        <span class="n">low_limit</span><span class="p">,</span> <span class="n">high_limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span><span class="o">.</span><span class="n">input_normalization_minimum</span><span class="p">[</span><span class="n">ix</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span><span class="o">.</span><span class="n">input_normalization_maximum</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
        <span class="n">indoor_dry_bulb_temperature</span> <span class="o">=</span> <span class="n">indoor_dry_bulb_temperature_norm</span><span class="o">*</span><span class="p">(</span><span class="n">high_limit</span> <span class="o">-</span> <span class="n">low_limit</span><span class="p">)</span> <span class="o">+</span> <span class="n">low_limit</span>
        
        <span class="c1"># update temperature</span>
        <span class="c1"># this function is called after advancing to next timestep </span>
        <span class="c1"># so the cooling demand update and this temperature update are set at the same time step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">indoor_dry_bulb_temperature</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span> <span class="o">=</span> <span class="n">indoor_dry_bulb_temperature</span><span class="o">.</span><span class="n">item</span><span class="p">()</span></div>


<div class="viewcode-block" id="LSTMDynamicsBuilding.get_dynamics_input">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.LSTMDynamicsBuilding.get_dynamics_input">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_dynamics_input</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="n">model_input</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span><span class="o">.</span><span class="n">input_observation_names</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;indoor_dry_bulb_temperature&#39;</span><span class="p">:</span>
                <span class="c1"># indoor temperature values are t = (t - lookback - 1) : t = (t - 1)</span>
                <span class="c1">#  i.e. use samples from previous time step to current time step</span>
                <span class="n">model_input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span><span class="o">.</span><span class="n">_model_input</span><span class="p">[</span><span class="n">i</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># other values are t = (t - lookback) : t = (t)</span>
                <span class="c1">#  i.e. use samples from previous time step to current time step</span>
                <span class="n">model_input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span><span class="o">.</span><span class="n">_model_input</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span>

        <span class="n">model_input</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">model_input</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">model_input</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_update_dynamics_input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates and returns the input time series for the dynmaics prediction model.</span>

<span class="sd">        Updates the model input with the input variables for the current time step. </span>
<span class="sd">        The variables in the input will have length of lookback + 1.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># get relevant observations for the current time step</span>
        <span class="n">observations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observations</span><span class="p">(</span><span class="n">include_all</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">periodic_normalization</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># append current time step observations to model input</span>
        <span class="c1"># leave out the oldest set of observations and keep only the previous n</span>
        <span class="c1"># where n is the lookback + 1 (to include current time step observations)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span><span class="o">.</span><span class="n">_model_input</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">l</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span><span class="o">.</span><span class="n">lookback</span><span class="p">:]</span> <span class="o">+</span> <span class="p">[(</span><span class="n">observations</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">min_</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">max_</span> <span class="o">-</span> <span class="n">min_</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">min_</span><span class="p">,</span> <span class="n">max_</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span><span class="o">.</span><span class="n">_model_input</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span><span class="o">.</span><span class="n">input_observation_names</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span><span class="o">.</span><span class="n">input_normalization_minimum</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span><span class="o">.</span><span class="n">input_normalization_maximum</span>
            <span class="p">)</span>
        <span class="p">]</span>

<div class="viewcode-block" id="LSTMDynamicsBuilding.update_cooling_demand">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.LSTMDynamicsBuilding.update_cooling_demand">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_cooling_demand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update space cooling demand for current time step.</span>

<span class="sd">        Sets the value of :py:attr:`citylearn.building.Building.energy_simulation.cooling_demand` for the current `time_step` to</span>
<span class="sd">        the ouput energy of the cooling device where the proportion of its nominal power made available is defined by `action`.</span>
<span class="sd">        If :py:attr:`citylearn.building.Building.energy_simulation.hvac_mode` at the next time step is = 0, i.e., off, or = 1, </span>
<span class="sd">        i.e. cooling mode, the demand is set to 0.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        action: float</span>
<span class="sd">            Proportion of cooling device nominal power that is made available.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Will only start controlling the heat pump when there are enough observations fo the LSTM lookback until then, maintains</span>
<span class="sd">        ideal load. This will imply that the agent does not learn anything in the initial timesteps that are less than the</span>
<span class="sd">        lookback. Taking this approach as a &#39;warm-up&#39; because realistically, there will be no preceding observations to use in </span>
<span class="sd">        lookback.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># only start controlling the heat pump when there are enough observations fo the LSTM lookback</span>
        <span class="c1"># until then, maintain ideal load. This will imply that the agent does not learn anything in the</span>
        <span class="c1"># initial timesteps that are less than the lookback. How does this affect learning longterm?</span>
        <span class="c1"># Taking this approach as a &#39;warm-up&#39; because realistically, there will be no preceding observations</span>
        <span class="c1"># to use in lookback. Alternatively, one can use the rolled observation values at the end of the time series</span>
        <span class="c1"># but it complicates things and is not too realistic.</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;cooling_device&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_actions</span> <span class="ow">or</span> <span class="s1">&#39;cooling_or_heating_device&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_actions</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_dynamics</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">hvac_mode</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]:</span>
                <span class="n">electric_power</span> <span class="o">=</span> <span class="n">action</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooling_device</span><span class="o">.</span><span class="n">nominal_power</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm_action_based_time_step_hours_ratio</span>
                <span class="n">demand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooling_device</span><span class="o">.</span><span class="n">get_max_output_power</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">weather</span><span class="o">.</span><span class="n">outdoor_dry_bulb_temperature</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">],</span>
                    <span class="n">heating</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">max_electric_power</span><span class="o">=</span><span class="n">electric_power</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">demand</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">cooling_demand</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span> <span class="o">=</span> <span class="n">demand</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span></div>


<div class="viewcode-block" id="LSTMDynamicsBuilding.update_heating_demand">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.LSTMDynamicsBuilding.update_heating_demand">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_heating_demand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update space heating demand for current time step.</span>

<span class="sd">        Sets the value of :py:attr:`citylearn.building.Building.energy_simulation.heating_demand` for the current `time_step` to</span>
<span class="sd">        the ouput energy of the heating device where the proportion of its nominal power made available is defined by `action`.</span>
<span class="sd">        If :py:attr:`citylearn.building.Building.energy_simulation.hvac_mode` at the next time step is = 0, i.e., off, or = 1, </span>
<span class="sd">        i.e. cooling mode, the demand is set to 0.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        action: float</span>
<span class="sd">            Proportion of heating device nominal power that is made available.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Will only start controlling the heat pump when there are enough observations fo the LSTM lookback until then, maintains</span>
<span class="sd">        ideal load. This will imply that the agent does not learn anything in the initial timesteps that are less than the</span>
<span class="sd">        lookback. Taking this approach as a &#39;warm-up&#39; because realistically, there will be no preceding observations to use in </span>
<span class="sd">        lookback.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;heating_device&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_actions</span> <span class="ow">or</span> <span class="s1">&#39;cooling_or_heating_device&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_actions</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_dynamics</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">hvac_mode</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]:</span>
                <span class="n">electric_power</span> <span class="o">=</span> <span class="n">action</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">nominal_power</span>
                <span class="n">demand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">get_max_output_power</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">weather</span><span class="o">.</span><span class="n">outdoor_dry_bulb_temperature</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">],</span>
                    <span class="n">heating</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">max_electric_power</span><span class="o">=</span><span class="n">electric_power</span>
                <span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="p">,</span> <span class="n">HeatPump</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">heating_device</span><span class="o">.</span><span class="n">get_max_output_power</span><span class="p">(</span><span class="n">max_electric_power</span><span class="o">=</span><span class="n">electric_power</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">demand</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">heating_demand</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span> <span class="o">=</span> <span class="n">demand</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span></div>
</div>


<div class="viewcode-block" id="OccupantInteractionBuilding">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.OccupantInteractionBuilding">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">OccupantInteractionBuilding</span><span class="p">(</span><span class="n">DynamicsBuilding</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Base class for temperature dynamic and occupant interaction building.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    *args: Any</span>
<span class="sd">        Positional arguments in :py:class:`citylearn.building.Building`.</span>
<span class="sd">    occupant: Occupant</span>
<span class="sd">        Occupant thermostat interaction model.</span>
<span class="sd">    ignore_occupant: bool, default: False</span>
<span class="sd">        Wether to ignore occupant interaction.</span>

<span class="sd">    Other Parameters</span>
<span class="sd">    ----------------</span>
<span class="sd">    **kwargs : Any</span>
<span class="sd">        Other keyword arguments used to initialize :py:class:`citylearn.building.Building` super class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">occupant</span><span class="p">:</span> <span class="n">Occupant</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ignore_occupant</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Intialize `OccupantInteractionBuilding`&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">occupant</span> <span class="o">=</span> <span class="n">occupant</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_occupant</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">ignore_occupant</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ignore_occupant</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    
    <span class="nd">@DynamicsBuilding</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">episode_tracker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">episode_tracker</span><span class="p">:</span> <span class="n">EpisodeTracker</span><span class="p">):</span>
        <span class="n">DynamicsBuilding</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">fset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">episode_tracker</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">occupant</span><span class="o">.</span><span class="n">episode_tracker</span> <span class="o">=</span> <span class="n">episode_tracker</span>

    <span class="nd">@DynamicsBuilding</span><span class="o">.</span><span class="n">random_seed</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">random_seed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">DynamicsBuilding</span><span class="o">.</span><span class="n">random_seed</span><span class="o">.</span><span class="n">fset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">occupant</span><span class="o">.</span><span class="n">random_seed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span>
    
<div class="viewcode-block" id="OccupantInteractionBuilding.apply_actions">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.OccupantInteractionBuilding.apply_actions">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">apply_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">apply_actions</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_dynamics</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_set_points</span><span class="p">()</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span></div>


<div class="viewcode-block" id="OccupantInteractionBuilding.update_set_points">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.OccupantInteractionBuilding.update_set_points">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_set_points</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update building indoor temperature dry-bulb temperature, humidity, etc setpoint using occupant interaction model.&quot;&quot;&quot;</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

    
<div class="viewcode-block" id="OccupantInteractionBuilding.reset_dynamic_variables">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.OccupantInteractionBuilding.reset_dynamic_variables">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reset_dynamic_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resets data file variables that change during control to their initial values.</span>
<span class="sd">        </span>
<span class="sd">        Resets cooling demand, heating deamand and indoor temperature time series to their initial value </span>
<span class="sd">        at the beginning of an episode.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">start_ix</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">end_ix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">episode_time_steps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">indoor_dry_bulb_temperature_cooling_set_point</span><span class="p">[</span><span class="n">start_ix</span><span class="p">:</span><span class="n">end_ix</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">indoor_dry_bulb_temperature_cooling_set_point_without_control</span><span class="o">.</span><span class="n">copy</span><span class="p">()[</span><span class="n">start_ix</span><span class="p">:</span><span class="n">end_ix</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">indoor_dry_bulb_temperature_heating_set_point</span><span class="p">[</span><span class="n">start_ix</span><span class="p">:</span><span class="n">end_ix</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">indoor_dry_bulb_temperature_heating_set_point_without_control</span><span class="o">.</span><span class="n">copy</span><span class="p">()[</span><span class="n">start_ix</span><span class="p">:</span><span class="n">end_ix</span><span class="p">]</span></div>


<div class="viewcode-block" id="OccupantInteractionBuilding.next_time_step">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.OccupantInteractionBuilding.next_time_step">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">next_time_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">next_time_step</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">occupant</span><span class="o">.</span><span class="n">next_time_step</span><span class="p">()</span></div>

        
<div class="viewcode-block" id="OccupantInteractionBuilding.reset">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.OccupantInteractionBuilding.reset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset Building to initial state and resets `dynamics` and `occupant`.&quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">occupant</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span></div>
</div>


<div class="viewcode-block" id="LogisticRegressionOccupantInteractionBuilding">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.LogisticRegressionOccupantInteractionBuilding">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">LogisticRegressionOccupantInteractionBuilding</span><span class="p">(</span><span class="n">OccupantInteractionBuilding</span><span class="p">,</span> <span class="n">LSTMDynamicsBuilding</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">occupant</span><span class="p">:</span> <span class="n">LogisticRegressionOccupant</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">set_point_hold_time_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">occupant</span><span class="o">=</span><span class="n">occupant</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">occupant</span><span class="p">:</span> <span class="n">LogisticRegressionOccupant</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__set_point_hold_time_step_counter</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_point_hold_time_steps</span> <span class="o">=</span> <span class="n">set_point_hold_time_steps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">occupant_interaction_indoor_dry_bulb_temperature_set_point_delta_summary</span> <span class="o">=</span> <span class="p">[]</span>
        
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_point_hold_time_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_point_hold_time_steps</span>
    
    <span class="nd">@set_point_hold_time_steps</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_point_hold_time_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;set_point_hold_time_steps must be &gt;= 0&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__set_point_hold_time_steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<div class="viewcode-block" id="LogisticRegressionOccupantInteractionBuilding.update_set_points">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.LogisticRegressionOccupantInteractionBuilding.update_set_points">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_set_points</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">current_cooling_set_point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">indoor_dry_bulb_temperature_cooling_set_point</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span>
        <span class="n">previous_cooling_set_point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">indoor_dry_bulb_temperature_cooling_set_point</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">current_heating_set_point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">indoor_dry_bulb_temperature_heating_set_point</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span>
        <span class="n">previous_heating_set_point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">indoor_dry_bulb_temperature_heating_set_point</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">hvac_mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">hvac_mode</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">hvac_mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">current_set_point</span> <span class="o">=</span> <span class="n">current_cooling_set_point</span>
            <span class="n">previous_set_point</span> <span class="o">=</span> <span class="n">previous_cooling_set_point</span>

        <span class="k">elif</span> <span class="n">hvac_mode</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">current_set_point</span> <span class="o">=</span> <span class="n">current_heating_set_point</span>
            <span class="n">previous_set_point</span> <span class="o">=</span> <span class="n">previous_heating_set_point</span>

        <span class="k">elif</span> <span class="n">hvac_mode</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s1">&#39;Setpoint update not implemented for auto hvac mode.&#39;</span> 
                <span class="s1">&#39; Set hvac_mode in citylearn.Building.energy_simulation to 0 (off), 1 (cooling mode) or 2 (heating mode).&#39;</span>
            <span class="p">)</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">current_temperature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">indoor_dry_bulb_temperature</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span>
        <span class="n">previous_temperature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">indoor_dry_bulb_temperature</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">interaction_input</span> <span class="o">=</span> <span class="n">current_temperature</span>
        <span class="n">delta_input</span> <span class="o">=</span> <span class="p">[[</span><span class="n">current_set_point</span><span class="p">,</span> <span class="n">previous_set_point</span><span class="p">,</span> <span class="n">previous_temperature</span> <span class="o">-</span> <span class="n">previous_set_point</span><span class="p">]]</span>
        <span class="n">model_input</span> <span class="o">=</span> <span class="p">(</span><span class="n">interaction_input</span><span class="p">,</span> <span class="n">delta_input</span><span class="p">)</span> 
        <span class="n">setpoint_delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">occupant</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">model_input</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">occupant</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">occupant_interaction_indoor_dry_bulb_temperature_set_point_delta</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span> <span class="o">=</span> <span class="n">setpoint_delta</span>

        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">setpoint_delta</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_occupant</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">hvac_mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">indoor_dry_bulb_temperature_cooling_set_point</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">:]</span> <span class="o">=</span> <span class="n">current_set_point</span> <span class="o">+</span> <span class="n">setpoint_delta</span>

            <span class="k">elif</span> <span class="n">hvac_mode</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">indoor_dry_bulb_temperature_heating_set_point</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">:]</span> <span class="o">=</span> <span class="n">current_set_point</span> <span class="o">+</span> <span class="n">setpoint_delta</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">__set_point_hold_time_step_counter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_point_hold_time_steps</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_point_hold_time_step_counter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__set_point_hold_time_step_counter</span> <span class="o">-=</span> <span class="mi">1</span>
        
        <span class="c1"># revert back to default setpoint schedule if no occupant interaction in defined window</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_point_hold_time_step_counter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_point_hold_time_step_counter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">indoor_dry_bulb_temperature_cooling_set_point</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span> \
                <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">indoor_dry_bulb_temperature_cooling_set_point_without_control</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">indoor_dry_bulb_temperature_heating_set_point</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span> \
                <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_simulation</span><span class="o">.</span><span class="n">indoor_dry_bulb_temperature_heating_set_point_without_control</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__set_point_hold_time_step_counter</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_get_observations_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="o">**</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_get_observations_data</span><span class="p">(),</span>
            <span class="o">**</span><span class="p">{</span>
                <span class="n">k</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">occupant</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">))[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">]</span> 
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">occupant</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_observation_space_limits_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="o">**</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_get_observation_space_limits_data</span><span class="p">(),</span>
            <span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">occupant</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span>
                <span class="n">k</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">),</span> 
                <span class="n">start_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_start_time_step</span><span class="p">,</span> 
                <span class="n">end_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">simulation_end_time_step</span>
            <span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">occupant</span><span class="o">.</span><span class="n">parameters</span><span class="p">)},</span>
        <span class="p">}</span>

        <span class="c1"># hacky way to set the limits for the occupant setpoint change delta</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">occupant</span><span class="o">.</span><span class="n">delta_output_map</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;occupant_interaction_indoor_dry_bulb_temperature_set_point_delta&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">delta</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;occupant_interaction_indoor_dry_bulb_temperature_set_point_delta&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">delta</span>

        <span class="k">return</span> <span class="n">data</span>

<div class="viewcode-block" id="LogisticRegressionOccupantInteractionBuilding.reset_data_sets">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.LogisticRegressionOccupantInteractionBuilding.reset_data_sets">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reset_data_sets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">reset_data_sets</span><span class="p">()</span>
        <span class="n">start_time_step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">episode_start_time_step</span>
        <span class="n">end_time_step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">episode_end_time_step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">occupant</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">start_time_step</span> <span class="o">=</span> <span class="n">start_time_step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">occupant</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">end_time_step</span> <span class="o">=</span> <span class="n">end_time_step</span></div>


<div class="viewcode-block" id="LogisticRegressionOccupantInteractionBuilding.reset_dynamic_variables">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.LogisticRegressionOccupantInteractionBuilding.reset_dynamic_variables">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reset_dynamic_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">reset_dynamic_variables</span><span class="p">()</span>
        <span class="n">start_ix</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">end_ix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">episode_tracker</span><span class="o">.</span><span class="n">episode_time_steps</span>
        <span class="n">delta_summary</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">occupant</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">occupant_interaction_indoor_dry_bulb_temperature_set_point_delta</span><span class="p">[</span><span class="n">start_ix</span><span class="p">:</span><span class="n">end_ix</span><span class="p">],</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">occupant_interaction_indoor_dry_bulb_temperature_set_point_delta_summary</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">delta_summary</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">delta_summary</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">occupant</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">occupant_interaction_indoor_dry_bulb_temperature_set_point_delta</span><span class="p">[</span><span class="n">start_ix</span><span class="p">:</span><span class="n">end_ix</span><span class="p">]</span> <span class="o">=</span>\
            <span class="bp">self</span><span class="o">.</span><span class="n">occupant</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">occupant_interaction_indoor_dry_bulb_temperature_set_point_delta_without_control</span><span class="o">.</span><span class="n">copy</span><span class="p">()[</span><span class="n">start_ix</span><span class="p">:</span><span class="n">end_ix</span><span class="p">]</span></div>


<div class="viewcode-block" id="LogisticRegressionOccupantInteractionBuilding.reset">
<a class="viewcode-back" href="../../api/citylearn.building.html#citylearn.building.LogisticRegressionOccupantInteractionBuilding.reset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__set_point_hold_time_step_counter</span> <span class="o">=</span> <span class="kc">None</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Jose Ramon Vazquez-Canteli, Kingsley Nweye, Zoltan Nagy.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>